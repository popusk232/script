local Library = {}
local Components = {}

-- Сервисы Roblox
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")

-- Настройки GUI
local GuiToggleKey = Enum.KeyCode.Insert -- Клавиша для открытия/закрытия
local IsGuiVisible = false

-- Тема, извлеченная из Crim.lua
local CrimTheme = {
    -- Основное окно / Фон
    BACKGROUND = Color3.fromRGB(24, 24, 24), -- Цвет основного окна
    SIDEBAR = Color3.fromRGB(18, 18, 18),   -- Цвет боковой панели
    OUTLINE = Color3.fromRGB(35, 35, 35),   -- Цвет обводки (для рамки или неактивных элементов)
    
    -- Акцентный цвет (Зеленый)
    ACCENT = Color3.fromRGB(70, 200, 70),   -- Цвет активных элементов и индикатора вкладки

    -- Элементы (Кнопки, Слайдеры, Переключатели)
    ELEMENT_BACKGROUND_OFF = Color3.fromRGB(35, 35, 35), -- Фон неактивного переключателя
    ELEMENT_BACKGROUND_ON = Color3.fromRGB(70, 200, 70),  -- Фон активного переключателя
    ELEMENT_TEXT = Color3.fromRGB(255, 255, 255),        -- Белый текст
    ELEMENT_FONT = Enum.Font.Gotham,                    -- Шрифт Gotham
    ELEMENT_TEXT_SIZE = 14,                             -- Размер текста

    -- Слайдеры
    SLIDER_KNOB = Color3.fromRGB(255, 255, 255),         -- Белый ползунок
    
    -- Текст вкладок
    TAB_TEXT_UNSELECTED = Color3.fromRGB(140, 140, 140), -- Цвет невыбранного текста вкладки
    TAB_TEXT_SELECTED = Color3.fromRGB(255, 255, 255),   -- Цвет выбранного текста вкладки
}

-- Вспомогательная функция для создания объектов
local function create(className, properties)
    local obj = Instance.new(className)
    for k, v in pairs(properties) do
        obj[k] = v
    end
    return obj
end

--================================================================================================================
-- БИБЛИОТЕКА / ОКНО (Window)
--================================================================================================================

local WindowValue = { Tabs = {}, CurrentTab = nil }

function Library:CreateWindow(settings)
    settings = settings or {}

    -- Основной ScreenGui
    local ScreenGui = create("ScreenGui", {
        Name = "Crimfield",
        Parent = CoreGui,
        DisplayOrder = 999,
        IgnoreGuiInset = true,
        ResetOnSpawn = false,
    })

    -- Главный фрейм (Окно)
    local MainFrame = create("Frame", {
        Name = "MainFrame",
        Parent = ScreenGui,
        Size = UDim2.new(0, 700, 0, 500),
        Position = UDim2.new(0.5, -350, 0.5, -250), -- Центрирование
        BackgroundColor3 = CrimTheme.BACKGROUND,
        BackgroundTransparency = 0.1, -- Базовая прозрачность
        ZIndex = 2,
    })

    create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = MainFrame,
    })
    
    -- Обводка основного фрейма (имитация дизайна Crim.lua)
    create("UIStroke", {
        Color = CrimTheme.OUTLINE,
        Thickness = 1,
        Parent = MainFrame
    })

    -- Боковая панель для вкладок
    local SidebarFrame = create("Frame", {
        Name = "SidebarFrame",
        Parent = MainFrame,
        Size = UDim2.new(0, 70, 1, 0),
        BackgroundColor3 = CrimTheme.SIDEBAR,
        ZIndex = 3,
    })
    
    -- Контейнер для содержимого вкладок
    local ContentFrame = create("Frame", {
        Name = "ContentFrame",
        Parent = MainFrame,
        Size = UDim2.new(1, -70, 1, 0),
        Position = UDim2.new(0, 70, 0, 0),
        BackgroundTransparency = 1,
        ClipsDescendants = true,
        ZIndex = 2,
    })
    
    local TabContainer = create("Frame", {
        Name = "TabContainer",
        Parent = ContentFrame,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        ZIndex = 2,
    })
    
    local TabPages = create("Frame", {
        Name = "TabPages",
        Parent = TabContainer,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        ClipsDescendants = true,
        ZIndex = 2,
    })
    
    create("UIPageLayout", {
        Name = "UIPageLayout",
        Parent = TabPages,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 0),
        Animation = Enum.LayoutAnimation.None,
    })

    -- Заголовок окна
    local TitleLabel = create("TextLabel", {
        Name = "TitleLabel",
        Parent = MainFrame,
        Text = settings.Name or "Crimfield GUI",
        Size = UDim2.new(1, -70, 0, 30),
        Position = UDim2.new(0, 70, 0, 0),
        Font = CrimTheme.ELEMENT_FONT,
        TextSize = 18,
        TextColor3 = CrimTheme.ACCENT,
        BackgroundTransparency = 1,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextWrapped = true,
        ZIndex = 3,
    })
    
    -- Базовая функция перетаскивания (Draggable)
    local isDragging = false
    local dragOffset = Vector2.new()

    MainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            isDragging = true
            local mousePos = UserInputService:GetMouseLocation()
            dragOffset = mousePos - MainFrame.AbsolutePosition
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    isDragging = false
                end
            end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if isDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local mousePos = UserInputService:GetMouseLocation()
            local newPos = mousePos - dragOffset
            MainFrame.Position = UDim2.fromOffset(newPos.X, newPos.Y)
        end
    end)
    
    -- Видимость (Insert Key)
    UserInputService.InputBegan:Connect(function(input, gameProcessedEvent)
        if gameProcessedEvent then return end
        if input.KeyCode == GuiToggleKey then
            IsGuiVisible = not IsGuiVisible
            MainFrame.Visible = IsGuiVisible
            -- Установка поведения мыши (как в Crim.lua)
            UserInputService.MouseBehavior = Enum.MouseBehavior.Default 
        end
    end)
    
    MainFrame.Visible = IsGuiVisible

    -- Логика переключения вкладок
    local function switchTab(tabButton, tabPage)
        if WindowValue.CurrentTab then
            -- Сброс стиля предыдущей кнопки
            WindowValue.CurrentTab.Button.UIStroke.Color = CrimTheme.SIDEBAR
            WindowValue.CurrentTab.Button.Title.TextColor3 = CrimTheme.TAB_TEXT_UNSELECTED
        end
        
        -- Установка стиля активной кнопки (зеленая линия - как индикатор в Crim.lua)
        tabButton.UIStroke.Color = CrimTheme.ACCENT
        tabButton.Title.TextColor3 = CrimTheme.TAB_TEXT_SELECTED

        -- Переключение страницы в UIPageLayout
        TabPages.UIPageLayout:JumpTo(tabPage)
        
        WindowValue.CurrentTab = { Button = tabButton, Page = tabPage }
    end
    
    --================================================================================================================
    -- ВКЛАДКА (Tab)
    --================================================================================================================

    function WindowValue:CreateTab(tabSettings)
        local TabValue = { Elements = {} }
        
        local TabPage = create("Frame", {
            Name = tabSettings.Name,
            Parent = TabPages,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
        })

        -- Размещение элементов внутри вкладки (по вертикали)
        create("UIListLayout", {
            Parent = TabPage,
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 10),
            HorizontalAlignment = Enum.HorizontalAlignment.Left,
            VerticalAlignment = Enum.VerticalAlignment.Top,
            FillDirection = Enum.FillDirection.Vertical,
            -- Отступ слева (как в Crim.lua)
            Position = UDim2.new(0, 20, 0, 20),
        })
        
        -- Кнопка вкладки в Sidebar
        local TabButton = create("TextButton", {
            Name = tabSettings.Name .. "Tab",
            Parent = SidebarFrame,
            Size = UDim2.new(1, 0, 0, 70),
            BackgroundTransparency = 1,
            ZIndex = 4,
        })
        
        local Title = create("TextLabel", {
            Name = "Title",
            Parent = TabButton,
            Text = tabSettings.Name,
            Size = UDim2.new(1, -10, 1, 0),
            Position = UDim2.new(0, 5, 0, 0),
            BackgroundTransparency = 1,
            Font = CrimTheme.ELEMENT_FONT,
            TextSize = CrimTheme.ELEMENT_TEXT_SIZE,
            TextColor3 = CrimTheme.TAB_TEXT_UNSELECTED,
            TextXAlignment = Enum.TextXAlignment.Left,
        })

        -- Обводка/индикатор (по умолчанию цвет боковой панели)
        create("UIStroke", {
            Color = CrimTheme.SIDEBAR,
            Thickness = 2,
            ApplyStrokeMode = Enum.ApplyStrokeMode.Border,
            Parent = TabButton,
        })

        TabButton.MouseButton1Click:Connect(function()
            switchTab(TabButton, TabPage)
        end)
        
        -- Автоматический выбор первой созданной вкладки
        if not WindowValue.CurrentTab then
            switchTab(TabButton, TabPage)
        end

        --================================================================================================================
        -- ЭЛЕМЕНТЫ УПРАВЛЕНИЯ
        --================================================================================================================

        -- Переключатель (Toggle)
        function TabValue:CreateToggle(elementSettings)
            local ToggleValue = elementSettings.Default or false
            local ToggleFrame = create("TextButton", {
                Name = elementSettings.Name .. "Toggle",
                Parent = TabPage,
                Size = UDim2.new(0, 300, 0, 30),
                BackgroundColor3 = ToggleValue and CrimTheme.ELEMENT_BACKGROUND_ON or CrimTheme.ELEMENT_BACKGROUND_OFF,
                Font = CrimTheme.ELEMENT_FONT,
                Text = elementSettings.Name,
                TextColor3 = CrimTheme.ELEMENT_TEXT,
                TextSize = CrimTheme.ELEMENT_TEXT_SIZE,
                TextXAlignment = Enum.TextXAlignment.Left,
            })
            create("UICorner", { Parent = ToggleFrame })

            local StatusLabel = create("TextLabel", {
                Name = "Status",
                Parent = ToggleFrame,
                BackgroundTransparency = 1,
                Size = UDim2.new(0, 40, 1, 0),
                Position = UDim2.new(1, -45, 0, 0),
                Font = CrimTheme.ELEMENT_FONT,
                Text = ToggleValue and "ON" or "OFF",
                TextColor3 = CrimTheme.ELEMENT_TEXT,
                TextSize = CrimTheme.ELEMENT_TEXT_SIZE,
                TextXAlignment = Enum.TextXAlignment.Center,
            })

            local function updateToggle()
                ToggleFrame.BackgroundColor3 = ToggleValue and CrimTheme.ELEMENT_BACKGROUND_ON or CrimTheme.ELEMENT_BACKGROUND_OFF
                StatusLabel.Text = ToggleValue and "ON" or "OFF"
                
                if elementSettings.Callback then
                    pcall(elementSettings.Callback, ToggleValue)
                end
            end
            
            ToggleFrame.MouseButton1Click:Connect(function()
                ToggleValue = not ToggleValue
                updateToggle()
            end)
            
            updateToggle()

            return {
                Name = elementSettings.Name,
                Value = ToggleValue,
                Set = function(newValue)
                    ToggleValue = newValue
                    updateToggle()
                end
            }
        end
        
        -- Слайдер (Slider)
        function TabValue:CreateSlider(elementSettings)
            local MIN = elementSettings.Min or 0
            local MAX = elementSettings.Max or 100
            local STEP = elementSettings.Step or 1
            local CurrentValue = elementSettings.Default or MIN
            
            local SliderFrame = create("Frame", {
                Name = elementSettings.Name .. "Slider",
                Parent = TabPage,
                Size = UDim2.new(0, 300, 0, 50), 
                BackgroundTransparency = 1,
            })
            
            local Label = create("TextLabel", {
                Name = "Label",
                Parent = SliderFrame,
                Size = UDim2.new(1, 0, 0, 20),
                Position = UDim2.new(0, 0, 0, 0),
                BackgroundTransparency = 1,
                Font = CrimTheme.ELEMENT_FONT,
                Text = elementSettings.Name .. ": " .. tostring(CurrentValue),
                TextColor3 = CrimTheme.ELEMENT_TEXT,
                TextSize = CrimTheme.ELEMENT_TEXT_SIZE,
                TextXAlignment = Enum.TextXAlignment.Left,
            })

            local SliderBar = create("Frame", {
                Name = "SliderBar",
                Parent = SliderFrame,
                Size = UDim2.new(1, 0, 0, 8),
                Position = UDim2.new(0, 0, 0, 30),
                BackgroundColor3 = CrimTheme.ELEMENT_BACKGROUND_OFF,
            })
            create("UICorner", { Parent = SliderBar })

            local ProgressFill = create("Frame", {
                Name = "ProgressFill",
                Parent = SliderBar,
                Size = UDim2.new(0, 0, 1, 0),
                Position = UDim2.new(0, 0, 0, 0),
                BackgroundColor3 = CrimTheme.ACCENT,
            })
            create("UICorner", { Parent = ProgressFill })

            local Knob = create("TextButton", {
                Name = "Knob",
                Parent = SliderBar,
                Size = UDim2.new(0, 15, 0, 15),
                BackgroundColor3 = CrimTheme.SLIDER_KNOB,
                Text = "",
            })
            create("UICorner", { CornerRadius = UDim.new(0.5, 0), Parent = Knob }) -- Круглый ползунок
            
            local isDragging = false

            local function updateSlider(value)
                -- Применение шага и ограничение
                value = math.floor(value / STEP + 0.5) * STEP
                value = math.max(MIN, math.min(MAX, value))
                
                CurrentValue = value
                
                local normalized = (CurrentValue - MIN) / (MAX - MIN)
                local barWidth = SliderBar.AbsoluteSize.X
                local knobSize = Knob.AbsoluteSize.X
                
                -- Обновление UI
                ProgressFill.Size = UDim2.new(normalized, 0, 1, 0)
                -- Позиционирование ползунка по центру
                Knob.Position = UDim2.new(normalized, -(knobSize / 2), 0.5, -(knobSize / 2))
                Label.Text = string.format("%s: %.1f", elementSettings.Name, CurrentValue)
                
                if elementSettings.Callback then
                    pcall(elementSettings.Callback, CurrentValue)
                end
            end

            updateSlider(CurrentValue)
            
            -- Логика перетаскивания
            Knob.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    isDragging = true
                    input.Changed:Connect(function()
                        if input.UserInputState == Enum.UserInputState.End then
                            isDragging = false
                        end
                    end)
                end
            end)

            UserInputService.InputChanged:Connect(function(input)
                if isDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                    local mousePos = UserInputService:GetMouseLocation()
                    local barPos = SliderBar.AbsolutePosition
                    local barWidth = SliderBar.AbsoluteSize.X
                    
                    local relativeX = math.clamp(mousePos.X - barPos.X, 0, barWidth)
                    local normalized = relativeX / barWidth
                    local newValue = MIN + (normalized * (MAX - MIN))
                    
                    updateSlider(newValue)
                end
            end)

            return {
                Name = elementSettings.Name,
                Value = CurrentValue,
                Set = function(newValue)
                    updateSlider(newValue)
                end,
            }
        end
        -- Здесь можно добавить другие элементы (Button, Input, Dropdown и т.д.)

        return TabValue
    end

    return WindowValue
end

-- Присвоение библиотеки к глобальной переменной для удобного доступа
if getgenv then
    getgenv().Crimfield = Library
end

return Library
