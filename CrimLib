-- Sapphire GUI Library (v2 - Refactored Layout)
-- This script provides the core logic for creating a GUI with a sidebar and multi-column layout.

-- Essential Roblox services
local function getService(name)
    return game:GetService(name)
end

local HttpService = getService('HttpService')
local TweenService = getService("TweenService")
local UserInputService = getService("UserInputService")
local RunService = getService("RunService")
local Players = getService("Players")
local CoreGui = getService("CoreGui")

local SapphireLibrary = {
    Flags = {},
    Theme = {
        Default = {
            TextColor = Color3.fromRGB(240, 240, 240),
            Background = Color3.fromRGB(25, 25, 25),
            Topbar = Color3.fromRGB(34, 34, 34),
            Shadow = Color3.fromRGB(20, 20, 20),
            TabBackground = Color3.fromRGB(80, 80, 80),
            TabStroke = Color3.fromRGB(85, 85, 85),
            TabBackgroundSelected = Color3.fromRGB(210, 210, 210),
            TabTextColor = Color3.fromRGB(240, 240, 240),
            SelectedTabTextColor = Color3.fromRGB(50, 50, 50),
            ElementBackground = Color3.fromRGB(35, 35, 35),
            ElementBackgroundHover = Color3.fromRGB(40, 40, 40),
            SecondaryElementBackground = Color3.fromRGB(25, 25, 25),
            ElementStroke = Color3.fromRGB(50, 50, 50),
            SliderBackground = Color3.fromRGB(50, 138, 220),
            SliderProgress = Color3.fromRGB(50, 138, 220),
            SliderStroke = Color3.fromRGB(58, 163, 255),
            ToggleEnabled = Color3.fromRGB(0, 146, 214),
            ToggleDisabled = Color3.fromRGB(100, 100, 100),
            InputBackground = Color3.fromRGB(30, 30, 30),
        },
        Ragebot = {
            TextColor = Color3.fromRGB(200, 200, 200),
            Background = Color3.fromRGB(20, 20, 20),
            Topbar = Color3.fromRGB(18, 18, 18),
            Shadow = Color3.fromRGB(10, 10, 10),
            TabBackground = Color3.fromRGB(18, 18, 18),
            TabStroke = Color3.fromRGB(18, 18, 18),
            TabBackgroundSelected = Color3.fromRGB(25, 25, 25),
            TabTextColor = Color3.fromRGB(200, 200, 200),
            SelectedTabTextColor = Color3.fromRGB(255, 255, 255),
            ElementBackground = Color3.fromRGB(28, 28, 28),
            ElementBackgroundHover = Color3.fromRGB(32, 32, 32),
            SecondaryElementBackground = Color3.fromRGB(25, 25, 25),
            ElementStroke = Color3.fromRGB(28, 28, 28),
            SliderBackground = Color3.fromRGB(20, 20, 20),
            SliderProgress = Color3.fromRGB(60, 160, 255),
            SliderStroke = Color3.fromRGB(60, 160, 255),
            ToggleEnabled = Color3.fromRGB(60, 160, 255),
            ToggleDisabled = Color3.fromRGB(60, 60, 60),
            InputBackground = Color3.fromRGB(32, 32, 32),
        },
    }
}

local SelectedTheme = SapphireLibrary.Theme.Default

local function ChangeTheme(Theme)
    if typeof(Theme) == 'string' then
        SelectedTheme = SapphireLibrary.Theme[Theme] or SapphireLibrary.Theme.Default
    elseif typeof(Theme) == 'table' then
        SelectedTheme = Theme
    end
    if _G.SapphireMain then
        _G.SapphireMain.BackgroundColor3 = SelectedTheme.Background
    end
end

local function makeDraggable(object, dragObject)
    local dragging = false
    local dragInput, dragStart, startPos
    local function update(input)
        local delta = input.Position - dragStart
        object.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    dragObject.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = object.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    dragObject.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

local function getAssetUri(id)
    return "rbxassetid://" .. (tonumber(id) or 0)
end

function SapphireLibrary:CreateWindow(Settings)
    ChangeTheme(Settings.Theme)

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "Sapphire"
    ScreenGui.Parent = CoreGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.ResetOnSpawn = false

    local Main = Instance.new("Frame")
    Main.Name = "Main"
    Main.Parent = ScreenGui
    Main.BackgroundColor3 = SelectedTheme.Background
    Main.BorderSizePixel = 0
    Main.Position = UDim2.new(0.5, 0, 0.5, 0)
    Main.Size = UDim2.new(0, 843, 0, 575)
    Main.AnchorPoint = Vector2.new(0.5, 0.5)
    _G.SapphireMain = Main
    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, 8)
    MainCorner.Parent = Main

    local Header = Instance.new("Frame")
    Header.Name = "Header"
    Header.Parent = Main
    Header.BackgroundColor3 = SelectedTheme.Topbar
    Header.BorderSizePixel = 0
    Header.Size = UDim2.new(1, 0, 0, 60)
    local HeaderCorner = Instance.new("UICorner")
    HeaderCorner.CornerRadius = UDim.new(0, 8)
    HeaderCorner.Parent = Header

    local Title = Instance.new("TextLabel")
    Title.Parent = Header
    Title.BackgroundTransparency = 1
    Title.Position = UDim2.new(0, 70, 0, 18)
    Title.Size = UDim2.new(0, 200, 0, 24)
    Title.Font = Enum.Font.GothamBold
    Title.Text = Settings.Name or "Sapphire"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.TextSize = 20
    Title.TextXAlignment = Enum.TextXAlignment.Left

    local Sidebar = Instance.new("Frame")
    Sidebar.Name = "Sidebar"
    Sidebar.Parent = Main
    Sidebar.BackgroundColor3 = SelectedTheme.Topbar
    Sidebar.BorderSizePixel = 0
    Sidebar.Position = UDim2.new(0, 0, 0, 60)
    Sidebar.Size = UDim2.new(0, 70, 1, -60)

    local ContentFrame = Instance.new("Frame")
    ContentFrame.Name = "ContentFrame"
    ContentFrame.Parent = Main
    ContentFrame.BackgroundTransparency = 1
    ContentFrame.Position = UDim2.new(0, 70, 0, 60)
    ContentFrame.Size = UDim2.new(1, -70, 1, -60)
    ContentFrame.ClipsDescendants = true

    makeDraggable(Main, Header)

    local Window = {}
    local tabs = {}
    local currentTab = nil

    function Window:CreateTab(name, imageId)
        local tabData = {}
        local tabIndex = #tabs + 1

        local IconFrame = Instance.new("Frame")
        IconFrame.Name = "Tab_" .. name
        IconFrame.Parent = Sidebar
        IconFrame.BackgroundColor3 = SelectedTheme.Topbar
        IconFrame.BorderSizePixel = 0
        IconFrame.Position = UDim2.new(0, 0, 0, 15 + ((tabIndex - 1) * 70))
        IconFrame.Size = UDim2.new(1, 0, 0, 60)
        
        local ActiveIndicator = Instance.new("Frame")
        ActiveIndicator.Name = "Indicator"
        ActiveIndicator.Parent = IconFrame
        ActiveIndicator.BackgroundColor3 = SelectedTheme.SliderProgress
        ActiveIndicator.BorderSizePixel = 0
        ActiveIndicator.Size = UDim2.new(0, 0, 1, 0)
        
        local Icon = Instance.new("ImageLabel")
        Icon.Name = "Icon"
        Icon.Parent = IconFrame
        Icon.BackgroundTransparency = 1
        Icon.Position = UDim2.new(0.5, -16, 0.5, -16)
        Icon.Size = UDim2.new(0, 32, 0, 32)
        Icon.Image = getAssetUri(imageId)
        Icon.ImageColor3 = Color3.fromRGB(200, 200, 200)
        Icon.ScaleType = Enum.ScaleType.Fit
        
        local TabButton = Instance.new("TextButton")
        TabButton.Parent = IconFrame
        TabButton.BackgroundTransparency = 1
        TabButton.Size = UDim2.new(1, 0, 1, 0)
        TabButton.Text = ""

        local TabContent = Instance.new("Frame")
        TabContent.Parent = ContentFrame
        TabContent.BackgroundTransparency = 1
        TabContent.Size = UDim2.new(1, 0, 1, 0)
        TabContent.Visible = false
        
        local ContentLayout = Instance.new("UIListLayout")
        ContentLayout.Parent = TabContent
        ContentLayout.FillDirection = Enum.FillDirection.Horizontal
        ContentLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
        ContentLayout.VerticalAlignment = Enum.VerticalAlignment.Top
        ContentLayout.Padding = UDim.new(0, 18)
        
        tabData.button = IconFrame
        tabData.content = TabContent
        tabs[tabIndex] = tabData
        
        TabButton.MouseButton1Click:Connect(function()
            if currentTab == tabData then return end
            if currentTab then
                currentTab.content.Visible = false
                local oldIndicator = currentTab.button:FindFirstChild("Indicator")
                TweenService:Create(currentTab.button, TweenInfo.new(0.2), {BackgroundColor3 = SelectedTheme.Topbar}):Play()
                if oldIndicator then
                    TweenService:Create(oldIndicator, TweenInfo.new(0.2), {Size = UDim2.new(0, 0, 1, 0)}):Play()
                end
            end
            TabContent.Visible = true
            currentTab = tabData
            Title.Text = name
            TweenService:Create(IconFrame, TweenInfo.new(0.2), {BackgroundColor3 = SelectedTheme.TabBackgroundSelected}):Play()
            TweenService:Create(ActiveIndicator, TweenInfo.new(0.2), {Size = UDim2.new(0, 4, 1, 0)}):Play()
        end)
        
        TabButton.MouseEnter:Connect(function() if currentTab ~= tabData then TweenService:Create(IconFrame, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(22, 22, 22)}):Play() end end)
        TabButton.MouseLeave:Connect(function() if currentTab ~= tabData then TweenService:Create(IconFrame, TweenInfo.new(0.15), {BackgroundColor3 = SelectedTheme.Topbar}):Play() end end)

        if not currentTab then
            TabContent.Visible = true
            currentTab = tabData
            Title.Text = name
            IconFrame.BackgroundColor3 = SelectedTheme.TabBackgroundSelected
            ActiveIndicator.Size = UDim2.new(0, 4, 1, 0)
        end

        local Tab = {}
        function Tab:CreateColumn(columnTitle, width)
            width = width or 350

            local ColumnContainer = Instance.new("Frame")
            ColumnContainer.Name = columnTitle
            ColumnContainer.Parent = TabContent
            ColumnContainer.BackgroundColor3 = SelectedTheme.SecondaryElementBackground
            ColumnContainer.BorderSizePixel = 0
            ColumnContainer.Size = UDim2.new(0, width, 1, -36)
            ColumnContainer.Position = UDim2.new(0, 0, 0, 18)
            local ColumnCorner = Instance.new("UICorner")
            ColumnCorner.CornerRadius = UDim.new(0, 6)
            ColumnCorner.Parent = ColumnContainer

            local ColumnTitle = Instance.new("TextLabel")
            ColumnTitle.Parent = ColumnContainer
            ColumnTitle.BackgroundTransparency = 1
            ColumnTitle.Position = UDim2.new(0, 15, 0, 10)
            ColumnTitle.Size = UDim2.new(1, -30, 0, 25)
            ColumnTitle.Font = Enum.Font.GothamBold
            ColumnTitle.Text = columnTitle
            ColumnTitle.TextColor3 = Color3.fromRGB(180, 180, 180)
            ColumnTitle.TextSize = 12
            ColumnTitle.TextXAlignment = Enum.TextXAlignment.Left

            local ColumnFrame = Instance.new("ScrollingFrame")
            ColumnFrame.Name = "ColumnContent"
            ColumnFrame.Parent = ColumnContainer
            ColumnFrame.BackgroundTransparency = 1
            ColumnFrame.BorderSizePixel = 0
            ColumnFrame.Position = UDim2.new(0,0,0,35)
            ColumnFrame.Size = UDim2.new(1,0,1,-40)
            ColumnFrame.CanvasSize = UDim2.new(0,0,0,0)
            ColumnFrame.ScrollBarThickness = 4
            
            local ColumnLayout = Instance.new("UIListLayout")
            ColumnLayout.Parent = ColumnFrame
            ColumnLayout.SortOrder = Enum.SortOrder.LayoutOrder
            ColumnLayout.Padding = UDim.new(0, 5)
            ColumnLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
            
            local Column = {}

            function Column:CreateToggle(settings)
                local toggleState = settings.CurrentValue
                local ToggleFrame = Instance.new("Frame")
                ToggleFrame.Name = settings.Name
                ToggleFrame.Parent = ColumnFrame
                ToggleFrame.BackgroundColor3 = SelectedTheme.ElementBackground
                ToggleFrame.BorderSizePixel = 0
                ToggleFrame.Size = UDim2.new(1, -30, 0, 30)
                local ToggleCorner = Instance.new("UICorner")
                ToggleCorner.CornerRadius = UDim.new(0, 4)
                ToggleCorner.Parent = ToggleFrame
                
                local Label = Instance.new("TextLabel")
                Label.Parent = ToggleFrame
                Label.BackgroundTransparency = 1
                Label.Position = UDim2.new(0, 12, 0, 0)
                Label.Size = UDim2.new(0, 200, 1, 0)
                Label.Font = Enum.Font.Gotham
                Label.Text = settings.Name
                Label.TextSize = 13
                Label.TextXAlignment = Enum.TextXAlignment.Left

                local ToggleBg = Instance.new("Frame")
                ToggleBg.Parent = ToggleFrame
                ToggleBg.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
                ToggleBg.BorderSizePixel = 0
                ToggleBg.Position = UDim2.new(1, -38, 0.5, -10)
                ToggleBg.Size = UDim2.new(0, 32, 0, 20)
                local BgCorner = Instance.new("UICorner")
                BgCorner.CornerRadius = UDim.new(1, 0)
                BgCorner.Parent = ToggleBg
                
                local ToggleButton = Instance.new("Frame")
                ToggleButton.Parent = ToggleBg
                ToggleButton.BorderSizePixel = 0
                ToggleButton.Size = UDim2.new(0, 16, 0, 16)
                local ButtonCorner = Instance.new("UICorner")
                ButtonCorner.CornerRadius = UDim.new(1, 0)
                ButtonCorner.Parent = ToggleButton

                local function updateVisuals(value, animate)
                    local pos = value and UDim2.new(0, 14, 0, 2) or UDim2.new(0, 2, 0, 2)
                    local color = value and SelectedTheme.ToggleEnabled or SelectedTheme.ToggleDisabled
                    local textColor = value and Color3.fromRGB(255, 200, 50) or SelectedTheme.TextColor
                    if animate then
                        TweenService:Create(ToggleButton, TweenInfo.new(0.15, Enum.EasingStyle.Quad), {Position = pos, BackgroundColor3 = color}):Play()
                        TweenService:Create(Label, TweenInfo.new(0.15, Enum.EasingStyle.Quad), {TextColor3 = textColor}):Play()
                    else
                        ToggleButton.Position = pos
                        ToggleButton.BackgroundColor3 = color
                        Label.TextColor3 = textColor
                    end
                end
                updateVisuals(toggleState, false)

                local ClickButton = Instance.new("TextButton")
                ClickButton.Parent = ToggleFrame
                ClickButton.BackgroundTransparency = 1
                ClickButton.Size = UDim2.new(1, 0, 1, 0)
                ClickButton.Text = ""

                ClickButton.MouseButton1Click:Connect(function()
                    toggleState = not toggleState
                    updateVisuals(toggleState, true)
                    if settings.Callback then pcall(settings.Callback, toggleState) end
                end)
                 return { Set = function(v) toggleState = v; updateVisuals(v, true) end, GetValue = function() return toggleState end}
            end
            
            return Column
        end
        return Tab
    end
    return Window
end

SapphireLibrary.ModifyTheme = function(NewTheme)
    ChangeTheme(NewTheme)
end

return SapphireLibrary
