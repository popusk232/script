--[[
    SAPPHIRE UI — ФИНАЛЬНАЯ ВЕРСИЯ ДЛЯ GITHUB
    (МОДИФИЦИРОВАНО: Добавлен элемент Elements:Slider)
]]

local Library = {}

local Services = {
    TweenService = game:GetService("TweenService"),
    UserInputService = game:GetService("UserInputService"),
    CoreGui = game:GetService("CoreGui")
}

-- Вспомогательная функция для перетаскивания
local function makeDraggable(frame, dragObj)
    local dragging, dragInput, dragStart, startPos = false
    dragObj.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    dragObj.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
    end)
    Services.UserInputService.InputChanged:Connect(function(input)
        if dragging and input == dragInput then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
                                       startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

-- Вспомогательная функция для иконок (оставлена для полноты)
local function getIcon(id)
    return "https://assetdelivery.roblox.com/v1/asset/?id=" .. tostring(id):gsub("rbxassetid://", "")
end

local function Tab(data)
    local Tab = {}

    local Scroll = Instance.new("ScrollingFrame")
    Scroll.Name = data.name .. "Content"
    Scroll.BackgroundTransparency = 1
    Scroll.Position = UDim2.new(0, 70, 0, 60)
    Scroll.Size = UDim2.new(1, -70, 1, -60)
    Scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    Scroll.ScrollBarThickness = 4
    Scroll.ScrollBarImageColor3 = Color3.fromRGB(60, 60, 60)
    Scroll.Parent = data.ParentFrame
    Scroll.Visible = data.active
    
    local List = Instance.new("UIListLayout")
    List.Parent = Scroll
    List.SortOrder = Enum.SortOrder.LayoutOrder
    List.Padding = UDim.new(0, 5)
    List.HorizontalAlignment = Enum.HorizontalAlignment.Center
    List.VerticalAlignment = Enum.VerticalAlignment.Top

    -- Основной метод добавления секций
    function Tab:Section(title)
        local Frame = Instance.new("Frame", Scroll)
        Frame.Size = UDim2.new(1,-10,0,0)
        Frame.BackgroundTransparency = 1
        Frame.BorderSizePixel = 0
        Frame.ClipsDescendants = false

        local TitleLabel = Instance.new("TextLabel", Frame)
        TitleLabel.Size = UDim2.new(1, 0, 0, 20)
        TitleLabel.Position = UDim2.new(0, 0, 0, 0)
        TitleLabel.BackgroundTransparency = 1
        TitleLabel.Font = Enum.Font.GothamBold
        TitleLabel.Text = title
        TitleLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
        TitleLabel.TextSize = 14
        TitleLabel.TextXAlignment = Enum.TextXAlignment.Left

        local SectionFrame = Instance.new("Frame", Frame)
        SectionFrame.Size = UDim2.new(1, 0, 0, 0)
        SectionFrame.Position = UDim2.new(0, 0, 0, 20)
        SectionFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
        SectionFrame.BorderSizePixel = 0
        Instance.new("UICorner", SectionFrame).CornerRadius = UDim.new(0, 6)

        local ItemsLayout = Instance.new("UIListLayout", SectionFrame)
        ItemsLayout.SortOrder = Enum.SortOrder.LayoutOrder
        ItemsLayout.Padding = UDim.new(0, 2)
        ItemsLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
        ItemsLayout.VerticalAlignment = Enum.VerticalAlignment.Top

        local Elements = {}

        -- Реализация Toggle
        function Elements:Toggle(options)
            options.Enabled = options.Enabled or false
            local Frame = Instance.new("Frame", SectionFrame)
            Frame.Size = UDim2.new(1,-10,0,30)
            Frame.BackgroundColor3 = Color3.fromRGB(28,28,28)
            Frame.BorderSizePixel = 0
            Instance.new("UICorner", Frame).CornerRadius = UDim.new(0,4)
            
            local Label = Instance.new("TextLabel", Frame)
            Label.Size = UDim2.new(0,200,1,0)
            Label.Position = UDim2.new(0,12,0,0)
            Label.BackgroundTransparency = 1
            Label.Font = Enum.Font.Gotham
            Label.Text = options.Name or "Toggle"
            Label.TextColor3 = options.Enabled and Color3.fromRGB(255,200,50) or Color3.fromRGB(200,200,200)
            Label.TextSize = 13
            Label.TextXAlignment = Enum.TextXAlignment.Left

            local ToggleFrame = Instance.new("Frame", Frame)
            ToggleFrame.Size = UDim2.new(0,34,0,18)
            ToggleFrame.Position = UDim2.new(1,-46,0,6)
            ToggleFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
            ToggleFrame.BorderSizePixel = 0
            Instance.new("UICorner", ToggleFrame).CornerRadius = UDim.new(1,0)

            local Btn = Instance.new("Frame", ToggleFrame)
            Btn.Size = UDim2.new(0,14,0,14)
            Btn.Position = options.Enabled and UDim2.new(0,14,0,2) or UDim2.new(0,2,0,2)
            Btn.BackgroundColor3 = options.Enabled and Color3.fromRGB(60,160,255) or Color3.fromRGB(60,60,60)
            Btn.BorderSizePixel = 0
            Instance.new("UICorner", Btn).CornerRadius = UDim.new(1,0)

            local Click = Instance.new("TextButton", Frame)
            Click.Size = UDim2.new(1,0,1,0)
            Click.BackgroundTransparency = 1
            Click.Text = ""

            Click.MouseButton1Click:Connect(function()
                options.Enabled = not options.Enabled
                Services.TweenService:Create(Btn, TweenInfo.new(0.15), {
                    Position = options.Enabled and UDim2.new(0,14,0,2) or UDim2.new(0,2,0,2),
                    BackgroundColor3 = options.Enabled and Color3.fromRGB(60,160,255) or Color3.fromRGB(60,60,60)
                }):Play()
                Label.TextColor3 = options.Enabled and Color3.fromRGB(255,200,50) or Color3.fromRGB(200,200,200)
                if options.Callback then options.Callback(options.Enabled) end
            end)

            return Frame
        end
        
        -- >>> РЕАЛИЗАЦИЯ SLIDER (ПОЛЗУНОК) <<<
        function Elements:Slider(options)
            local Frame = Instance.new("Frame", SectionFrame)
            Frame.Size = UDim2.new(1,-10,0,40) -- Увеличиваем высоту
            Frame.BackgroundColor3 = Color3.fromRGB(28,28,28) 
            Frame.BorderSizePixel = 0
            Instance.new("UICorner", Frame).CornerRadius = UDim.new(0,4)
            
            local MinValue = options.Min or 0
            local MaxValue = options.Max or 100
            local Step = options.Step or 1
            local CurrentValue = options.Value or MinValue
            
            local initialRatio = math.clamp((CurrentValue - MinValue) / (MaxValue - MinValue), 0, 1)

            local Label = Instance.new("TextLabel", Frame)
            Label.Size = UDim2.new(0,150,0,15)
            Label.Position = UDim2.new(0,12,0,5)
            Label.BackgroundTransparency = 1
            Label.Font = Enum.Font.Gotham
            Label.Text = options.Name or "Slider"
            Label.TextColor3 = Color3.fromRGB(200,200,200) 
            Label.TextSize = 13
            Label.TextXAlignment = Enum.TextXAlignment.Left

            local ValueLabel = Instance.new("TextLabel", Frame)
            ValueLabel.Size = UDim2.new(0,50,0,15)
            ValueLabel.Position = UDim2.new(1,-62,0,5)
            ValueLabel.BackgroundTransparency = 1
            ValueLabel.Font = Enum.Font.Gotham
            ValueLabel.Text = tostring(CurrentValue)
            ValueLabel.TextColor3 = Color3.fromRGB(255,200,50)
            ValueLabel.TextSize = 13
            ValueLabel.TextXAlignment = Enum.TextXAlignment.Right

            -- Трек ползунка (фон)
            local SliderTrack = Instance.new("Frame", Frame)
            SliderTrack.Size = UDim2.new(1,-30,0,5)
            SliderTrack.Position = UDim2.new(0,15,0,23)
            SliderTrack.BackgroundColor3 = Color3.fromRGB(20,20,20) 
            SliderTrack.BorderSizePixel = 0
            Instance.new("UICorner", SliderTrack).CornerRadius = UDim.new(1,0)
            SliderTrack.Active = true
            SliderTrack.ZIndex = 2
            
            -- Заполнение ползунка
            local SliderFill = Instance.new("Frame", SliderTrack)
            SliderFill.Size = UDim2.new(initialRatio,0,1,0)
            SliderFill.BackgroundColor3 = Color3.fromRGB(60,160,255)
            SliderFill.BorderSizePixel = 0
            Instance.new("UICorner", SliderFill).CornerRadius = UDim.new(1,0)
            
            -- Бегунок (кнопка)
            local SliderThumb = Instance.new("Frame", SliderTrack)
            SliderThumb.Size = UDim2.new(0,10,0,10)
            SliderThumb.Position = UDim2.new(initialRatio,-5,0.5,-5)
            SliderThumb.BackgroundColor3 = Color3.fromRGB(255,200,50)
            SliderThumb.BorderSizePixel = 0
            Instance.new("UICorner", SliderThumb).CornerRadius = UDim.new(1,0)
            SliderThumb.Active = true
            SliderThumb.ZIndex = 3

            local dragging = false
            
            local function updateSlider(input)
                local mouseX = input.Position.X
                local absolutePositionX = SliderTrack.AbsolutePosition.X
                local absoluteSizeX = SliderTrack.AbsoluteSize.X
                
                local x = math.clamp(mouseX - absolutePositionX, 0, absoluteSizeX)
                local ratio = x / absoluteSizeX
                
                local newValue = MinValue + ratio * (MaxValue - MinValue)
                
                -- Округление до шага (Step)
                newValue = math.floor(newValue / Step + 0.5) * Step
                
                CurrentValue = math.clamp(newValue, MinValue, MaxValue)
                local finalRatio = (CurrentValue - MinValue) / (MaxValue - MinValue)
                
                SliderFill.Size = UDim2.new(finalRatio, 0, 1, 0)
                SliderThumb.Position = UDim2.new(finalRatio, -5, 0.5, -5)
                ValueLabel.Text = tostring(CurrentValue)
                
                if options.Callback then options.Callback(CurrentValue) end
            end

            -- Логика перетаскивания
            SliderThumb.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                end
            end)
            
            SliderTrack.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                    updateSlider(input) -- Обновление сразу при клике на трек
                end
            end)

            Services.UserInputService.InputChanged:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
                    updateSlider(input)
                end
            end)
            
            Services.UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                end
            end)

            return Frame
        end
        -- <<< КОНЕЦ SLIDER >>>
        
        -- Скрываем/раскрываем секцию
        TitleLabel.MouseButton1Click:Connect(function()
            SectionFrame.Visible = not SectionFrame.Visible
            -- Логика изменения CanvasSize должна быть добавлена здесь
        end)
        
        return Elements
    end

    return Tab
end

function Library:CreateWindow(config)
    local Name = (config and config.Name) or "Sapphire UI"
    local Tabs = (config and config.Tabs) or {}

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "SapphireUI"
    ScreenGui.Parent = Services.CoreGui
    ScreenGui.ResetOnSpawn = false

    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, 500, 0, 350) -- Уменьшенный размер для примера
    MainFrame.Position = UDim2.new(0.5, -250, 0.5, -175)
    MainFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
    MainFrame.BorderSizePixel = 0
    MainFrame.Visible = false
    MainFrame.Parent = ScreenGui
    MainFrame.ClipsDescendants = true
    Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0,8)
    
    local Header = Instance.new("Frame", MainFrame)
    Header.Size = UDim2.new(1,0,0,30)
    Header.BackgroundColor3 = Color3.fromRGB(18,18,18)
    Header.BorderSizePixel = 0
    Instance.new("UICorner", Header).CornerRadius = UDim.new(0,8)

    local TitleLabel = Instance.new("TextLabel", Header)
    TitleLabel.Size = UDim2.new(1,0,1,0)
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Font = Enum.Font.GothamBold
    TitleLabel.Text = Name
    TitleLabel.TextColor3 = Color3.fromRGB(255,255,255)
    TitleLabel.TextSize = 16

    local Sidebar = Instance.new("Frame", MainFrame)
    Sidebar.Size = UDim2.new(0,60,1,-30)
    Sidebar.Position = UDim2.new(0,0,0,30)
    Sidebar.BackgroundColor3 = Color3.fromRGB(15,15,15)
    Sidebar.BorderSizePixel = 0
    
    local TabList = Instance.new("UIListLayout", Sidebar)
    TabList.SortOrder = Enum.SortOrder.LayoutOrder
    TabList.Padding = UDim.new(0, 5)
    TabList.HorizontalAlignment = Enum.HorizontalAlignment.Center
    TabList.VerticalAlignment = Enum.VerticalAlignment.Top
    
    local Window = {}
    local currentTab = 1
    
    local tabButtons = {}

    local function selectTab(index, button, content)
        for i, btn in ipairs(tabButtons) do
            btn.BackgroundColor3 = Color3.fromRGB(15,15,15)
            Window[Tabs[i].name].Name.. "Content"].Visible = false
        end
        button.BackgroundColor3 = Color3.fromRGB(20,20,20)
        content.Visible = true
        currentTab = index
    end
    
    for index, data in ipairs(Tabs) do
        data.active = (index == currentTab)
        data.ParentFrame = MainFrame

        local TabButton = Instance.new("TextButton", Sidebar)
        TabButton.Size = UDim2.new(1,-10,0,50)
        TabButton.BackgroundColor3 = index == currentTab and Color3.fromRGB(20,20,20) or Color3.fromRGB(15,15,15)
        TabButton.BorderSizePixel = 0
        TabButton.Font = Enum.Font.GothamBold
        TabButton.Text = data.name:sub(1,1)
        TabButton.TextColor3 = Color3.fromRGB(255,200,50)
        TabButton.TextSize = 14
        Instance.new("UICorner", TabButton).CornerRadius = UDim.new(0,4)
        table.insert(tabButtons, TabButton)
        
        local tabInstance = Tab(data)
        Window[data.name] = tabInstance
        local tabContent = MainFrame:FindFirstChild(data.name .. "Content")

        TabButton.MouseButton1Click:Connect(function()
            selectTab(index, TabButton, tabContent)
        end)
    end

    -- Перетаскивание
    makeDraggable(MainFrame, Header) 

    local conn = Services.UserInputService.InputBegan:Connect(function(inp, gp)
        if gp then return end
        if inp.KeyCode == Enum.KeyCode.Insert then
            MainFrame.Visible = not MainFrame.Visible
        elseif inp.KeyCode == Enum.KeyCode.Delete then
            conn:Disconnect()
            ScreenGui:Destroy()
        end
    end)

    function Window:Toggle() MainFrame.Visible = not MainFrame.Visible end
    function Window:Unload() conn:Disconnect(); ScreenGui:Destroy() end

    return Window
end

return Library
