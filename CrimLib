if debugX then warn('Initialising Rayfield') end

local function getService(name)
	local service = game:GetService(name)
	return if cloneref then cloneref(service) else service
end

local function loadWithTimeout(url: string, timeout: number?): ...any
	assert(type(url) == "string", "Expected string, got " .. type(url))
	timeout = timeout or 5
	local requestCompleted = false
	local success, result = false, nil

	local requestThread = task.spawn(function()
		local fetchSuccess, fetchResult = pcall(game.HttpGet, game, url)
		if not fetchSuccess or #fetchResult == 0 then
			if #fetchResult == 0 then
				fetchResult = "Empty response"
			end
			success, result = false, fetchResult
			requestCompleted = true
			return
		end
		local content = fetchResult
		local execSuccess, execResult = pcall(function() return loadstring(content)() end)
		success, result = execSuccess, execResult
		requestCompleted = true
	end)

	local timeoutThread = task.delay(timeout, function()
		if not requestCompleted then
			warn(`Request for {url} timed out after {timeout} seconds`)
			task.cancel(requestThread)
			result = "Request timed out"
			requestCompleted = true
		end
	end)

	while not requestCompleted do
		task.wait()
	end
	if coroutine.status(timeoutThread) ~= "dead" then
		task.cancel(timeoutThread)
	end
	if not success then
		warn(`Failed to process {url}: {result}`)
	end
	return if success then result else nil
end

local requestsDisabled = true
local InterfaceBuild = '3K3W'
local Release = "Build 1.68"
local RayfieldFolder = "Rayfield"
local ConfigurationExtension = ".rfld"
local settingsTable = {
	General = {
		rayfieldOpen = {Type = 'bind', Value = 'K', Name = 'Rayfield Keybind'},
	},
	System = {
		usageAnalytics = {Type = 'toggle', Value = true, Name = 'Anonymised Analytics'},
	}
}

local overriddenSettings: { [string]: any } = {}
local function overrideSetting(category: string, name: string, value: any)
	overriddenSettings[`{category}.{name}`] = value
end

local function getSetting(category: string, name: string): any
	if overriddenSettings[`{category}.{name}`] ~= nil then
		return overriddenSettings[`{category}.{name}`]
	elseif settingsTable[category][name] ~= nil then
		return settingsTable[category][name].Value
	end
end

if requestsDisabled then
	overrideSetting("System", "usageAnalytics", false)
end

local HttpService = getService('HttpService')
local RunService = getService('RunService')

local useStudio = RunService:IsStudio() or false

local settingsCreated = false
local settingsInitialized = false
local cachedSettings
local prompt = useStudio and require(script.Parent.prompt) or loadWithTimeout('https://raw.githubusercontent.com/SiriusSoftwareLtd/Sirius/refs/heads/request/prompt.lua')
local requestFunc = (syn and syn.request) or (fluxus and fluxus.request) or (http and http.request) or http_request or request

if not prompt and not useStudio then
	warn("Failed to load prompt library, using fallback")
	prompt = {
		create = function() end
	}
end

local function loadSettings()
	local file = nil

	local success, result = pcall(function()
		task.spawn(function()
			if isfolder and isfolder(RayfieldFolder) then
				if isfile and isfile(RayfieldFolder..'/settings'..ConfigurationExtension) then
					file = readfile(RayfieldFolder..'/settings'..ConfigurationExtension)
				end
			end

			if useStudio then
				file = [[{"General":{"rayfieldOpen":{"Value":"K","Type":"bind","Name":"Rayfield Keybind","Element":{"HoldToInteract":false,"Ext":true,"Name":"Rayfield Keybind","Set":null,"CallOnChange":true,"Callback":null,"CurrentKeybind":"K"}}},"System":{"usageAnalytics":{"Value":false,"Type":"toggle","Name":"Anonymised Analytics","Element":{"Ext":true,"Name":"Anonymised Analytics","Set":null,"CurrentValue":false,"Callback":null}}}}]]
			end

			if file then
				local success, decodedFile = pcall(function() return HttpService:JSONDecode(file) end)
				if success then
					file = decodedFile
				else
					file = {}
				end
			else
				file = {}
			end

			if not settingsCreated then 
				cachedSettings = file
				return
			end

			if file ~= {} then
				for categoryName, settingCategory in pairs(settingsTable) do
					if file[categoryName] then
						for settingName, setting in pairs(settingCategory) do
							if file[categoryName][settingName] then
								setting.Value = file[categoryName][settingName].Value
								setting.Element:Set(getSetting(categoryName, settingName))
							end
						end
					end
				end
			end
			settingsInitialized = true
		end)
	end)

	if not success then 
		if writefile then
			warn('Rayfield had an issue accessing configuration saving capability.')
		end
	end
end

if debugX then warn('Now Loading Settings Configuration') end
loadSettings()
if debugX then warn('Settings Loaded') end

local analyticsLib
local sendReport = function(ev_n, sc_n) warn("Failed to load report function") end
if not requestsDisabled then
	if debugX then warn('Querying Settings for Reporter Information') end	
	analyticsLib = loadWithTimeout("https://analytics.sirius.menu/script")
	if not analyticsLib then
		warn("Failed to load analytics reporter")
		analyticsLib = nil
	elseif analyticsLib and type(analyticsLib.load) == "function" then
		analyticsLib:load()
	else
		warn("Analytics library loaded but missing load function")
		analyticsLib = nil
	end
	sendReport = function(ev_n, sc_n)
		if not (type(analyticsLib) == "table" and type(analyticsLib.isLoaded) == "function" and analyticsLib:isLoaded()) then
			warn("Analytics library not loaded")
			return
		end
		if useStudio then
			print('Sending Analytics')
		else
			if debugX then warn('Reporting Analytics') end
			analyticsLib:report(
				{
					["name"] = ev_n,
					["script"] = {["name"] = sc_n, ["version"] = Release}
				},
				{
					["version"] = InterfaceBuild
				}
			)
			if debugX then warn('Finished Report') end
		end
	end
	if cachedSettings and (#cachedSettings == 0 or (cachedSettings.System and cachedSettings.System.usageAnalytics and cachedSettings.System.usageAnalytics.Value)) then
		sendReport("execution", "Rayfield")
	elseif not cachedSettings then
		sendReport("execution", "Rayfield")
	end
end

local promptUser = 2
if promptUser == 1 and prompt and type(prompt.create) == "function" then
	prompt.create('Be cautious when running scripts',[[Please be careful when running scripts from unknown developers. This script has already been ran.<font transparency='0.3'>Some scripts may steal your items or in-game goods.</font>]], 'Okay', '', function() end)
end

if debugX then warn('Moving on to continue initialisation') end

local RayfieldLibrary = {
	Flags = {},
	Theme = {
		Default = {
			TextColor = Color3.fromRGB(255, 255, 255), 
			Background = Color3.fromRGB(20, 20, 20),
			Topbar = Color3.fromRGB(18, 18, 18),
			Shadow = Color3.fromRGB(15, 15, 15),
			NotificationBackground = Color3.fromRGB(20, 20, 20),
			NotificationActionsBackground = Color3.fromRGB(255, 255, 255),
			TabBackground = Color3.fromRGB(18, 18, 18),
			TabStroke = Color3.fromRGB(25, 25, 25),
			TabBackgroundSelected = Color3.fromRGB(25, 25, 25),
			TabTextColor = Color3.fromRGB(200, 200, 200),
			SelectedTabTextColor = Color3.fromRGB(255, 255, 255),
			ElementBackground = Color3.fromRGB(28, 28, 28),
			ElementBackgroundHover = Color3.fromRGB(35, 35, 35),
			SecondaryElementBackground = Color3.fromRGB(25, 25, 25),
			ElementStroke = Color3.fromRGB(40, 40, 40),
			SecondaryElementStroke = Color3.fromRGB(30, 30, 30),
			SliderBackground = Color3.fromRGB(60, 160, 255),
			SliderProgress = Color3.fromRGB(60, 160, 255),
			SliderStroke = Color3.fromRGB(80, 180, 255),
			ToggleBackground = Color3.fromRGB(30, 30, 30),
			ToggleEnabled = Color3.fromRGB(60, 160, 255),
			ToggleDisabled = Color3.fromRGB(80, 80, 80),
			ToggleEnabledStroke = Color3.fromRGB(80, 180, 255),
			ToggleDisabledStroke = Color3.fromRGB(100, 100, 100),
			ToggleEnabledOuterStroke = Color3.fromRGB(30, 30, 30),
			ToggleDisabledOuterStroke = Color3.fromRGB(65, 65, 65),
			DropdownSelected = Color3.fromRGB(40, 40, 40),
			DropdownUnselected = Color3.fromRGB(30, 30, 30),
			InputBackground = Color3.fromRGB(30, 30, 30),
			InputStroke = Color3.fromRGB(65, 65, 65),
			PlaceholderColor = Color3.fromRGB(178, 178, 178)
		}
	},
	CurrentTheme = "Default",
	Flags = {},
}

local function getTheme()
	return RayfieldLibrary.Theme[RayfieldLibrary.CurrentTheme]
end

local TweenService = getService('TweenService')
local UserInputService = getService('UserInputService')
local CoreGui = getService('CoreGui')
local StarterGui = getService('StarterGui')
local Players = getService('Players')

local Player = Players.LocalPlayer or nil
local Mouse = Player and Player:GetMouse() or nil
local ScreenGui = Instance.new('ScreenGui', CoreGui)
ScreenGui.Name = 'Rayfield'
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false

StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Chat, false)

local Main = Instance.new('Frame', ScreenGui)
Main.Name = 'Main'
Main.Size = UDim2.new(0, 715, 0, 500)
Main.Position = UDim2.new(0.5, -357.5, 0.5, -250)
Main.BackgroundTransparency = 1
Main.Active = true

local Library = Main:Clone()
Library.Name = 'Library'
Library.BackgroundTransparency = 1
Library.Size = UDim2.new(0, 0, 0, 0)
Library.Position = UDim2.new(0.5, 0, 0.5, 0)
Library.Parent = Main
Library.Visible = false

local LibraryToggleKey = Enum.KeyCode.RightControl

local function applyTheme()
	local theme = getTheme()
	local Notice = Main:FindFirstChild('Notice')
	if Notice then
		Notice.BackgroundColor3 = theme.NotificationBackground
		Notice.Title.TextColor3 = theme.TextColor
		Notice.Content.TextColor3 = theme.TextColor
		Notice.Icon.ImageColor3 = theme.SliderBackground
	end
	if Library.Visible then
		TweenService:Create(Library, TweenInfo.new(0.3), {BackgroundTransparency = 0}):Play()
	end
end

local function NewButton(group, name, callback)
    local theme = getTheme()
    local Button = Instance.new("Frame")
    Button.Name = "Button"
    Button.Size = UDim2.new(1, 0, 0, 30)
    Button.BackgroundColor3 = theme.ElementBackground
    Button.BorderColor3 = theme.ElementStroke
    Button.BorderSizePixel = 1
    local TextLabel = Instance.new("TextLabel")
    TextLabel.Text = name
    TextLabel.TextColor3 = theme.TextColor
    TextLabel.BackgroundTransparency = 1
    TextLabel.Size = UDim2.new(1, 0, 1, 0)
    TextLabel.Font = Enum.Font.SourceSans
    TextLabel.TextSize = 14
    TextLabel.Parent = Button
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 4)
    Corner.Parent = Button
    local ClickDetector = Instance.new("TextButton")
    ClickDetector.Size = UDim2.new(1, 0, 1, 0)
    ClickDetector.BackgroundTransparency = 1
    ClickDetector.Text = ""
    ClickDetector.Parent = Button

    ClickDetector.MouseButton1Click:Connect(function()
        if type(callback) == "function" then callback() end
    end)

    Button.Parent = group.Frame
    group:UpdateLayout()

    return {
        Button = Button,
        ClickDetector = ClickDetector,
        Set = function(text) TextLabel.Text = text end,
        Click = function() ClickDetector:Click() end
    }
end

local function NewToggle(group, name, defaultValue, callback)
    local theme = getTheme()
    local currentValue = defaultValue

    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Name = "Toggle"
    ToggleFrame.Size = UDim2.new(1, 0, 0, 30)
    ToggleFrame.BackgroundColor3 = theme.ElementBackground
    ToggleFrame.BorderColor3 = theme.ElementStroke
    ToggleFrame.BorderSizePixel = 1

    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 4)
    Corner.Parent = ToggleFrame

    local TextLabel = Instance.new("TextLabel")
    TextLabel.Text = name
    TextLabel.TextColor3 = theme.TextColor
    TextLabel.BackgroundTransparency = 1
    TextLabel.Position = UDim2.new(0, 5, 0, 0)
    TextLabel.Size = UDim2.new(1, -40, 1, 0)
    TextLabel.TextXAlignment = Enum.TextXAlignment.Left
    TextLabel.Font = Enum.Font.SourceSans
    TextLabel.TextSize = 14
    TextLabel.Parent = ToggleFrame
    
    local ToggleButton = Instance.new("Frame")
    ToggleButton.Name = "ToggleButton"
    ToggleButton.Size = UDim2.new(0, 20, 0, 20)
    ToggleButton.Position = UDim2.new(1, -25, 0.5, -10)
    ToggleButton.BackgroundColor3 = currentValue and theme.ToggleEnabled or theme.ToggleDisabled
    ToggleButton.BorderColor3 = currentValue and theme.ToggleEnabledStroke or theme.ToggleDisabledStroke
    ToggleButton.BorderSizePixel = 1
    ToggleButton.Parent = ToggleFrame

    local ToggleCorner = Instance.new("UICorner")
    ToggleCorner.CornerRadius = UDim.new(0, 10)
    ToggleCorner.Parent = ToggleButton

    local function updateVisuals(state)
        currentValue = state
        local targetColor = state and theme.ToggleEnabled or theme.ToggleDisabled
        local targetStroke = state and theme.ToggleEnabledStroke or theme.ToggleDisabledStroke
        TweenService:Create(ToggleButton, TweenInfo.new(0.2), {BackgroundColor3 = targetColor, BorderColor3 = targetStroke}):Play()
    end

    local ClickDetector = Instance.new("TextButton")
    ClickDetector.Size = UDim2.new(1, 0, 1, 0)
    ClickDetector.BackgroundTransparency = 1
    ClickDetector.Text = ""
    ClickDetector.Parent = ToggleFrame

    ClickDetector.MouseButton1Click:Connect(function()
        local newState = not currentValue
        updateVisuals(newState)
        if type(callback) == "function" then callback(newState) end
    end)
    
    updateVisuals(defaultValue)

    ToggleFrame.Parent = group.Frame
    group:UpdateLayout()

    return {
        Frame = ToggleFrame,
        Set = function(state) updateVisuals(state) end,
        Get = function() return currentValue end
    }
end

local function NewSlider(group, name, options, callback)
    local theme = getTheme()
    local currentValue = options.Current or options.Min
    local min = options.Min or 0
    local max = options.Max or 100
    local rounding = options.Rounding or 0
    local suffix = options.Suffix or ""
    
    local SliderFrame = Instance.new("Frame")
    SliderFrame.Name = "Slider"
    SliderFrame.Size = UDim2.new(1, 0, 0, 40)
    SliderFrame.BackgroundColor3 = theme.ElementBackground
    SliderFrame.BorderColor3 = theme.ElementStroke
    SliderFrame.BorderSizePixel = 1
    SliderFrame.Active = true

    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 4)
    Corner.Parent = SliderFrame
    
    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Text = name
    TitleLabel.TextColor3 = theme.TextColor
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Position = UDim2.new(0, 5, 0, 0)
    TitleLabel.Size = UDim2.new(1, -10, 0.5, 0)
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.Font = Enum.Font.SourceSans
    TitleLabel.TextSize = 14
    TitleLabel.Parent = SliderFrame

    local ValueLabel = Instance.new("TextLabel")
    ValueLabel.TextColor3 = theme.TextColor
    ValueLabel.BackgroundTransparency = 1
    ValueLabel.Position = UDim2.new(1, -5, 0, 0)
    ValueLabel.Size = UDim2.new(1, -10, 0.5, 0)
    ValueLabel.TextXAlignment = Enum.TextXAlignment.Right
    ValueLabel.Font = Enum.Font.SourceSans
    ValueLabel.TextSize = 14
    ValueLabel.Parent = SliderFrame
    
    local ProgressBackground = Instance.new("Frame")
    ProgressBackground.Name = "ProgressBackground"
    ProgressBackground.Size = UDim2.new(1, -10, 0, 8)
    ProgressBackground.Position = UDim2.new(0.5, 0, 0.75, -4)
    ProgressBackground.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    ProgressBackground.BorderSizePixel = 0
    ProgressBackground.Parent = SliderFrame

    local ProgressCorner = Instance.new("UICorner")
    ProgressCorner.CornerRadius = UDim.new(1, 0)
    ProgressCorner.Parent = ProgressBackground

    local Progress = Instance.new("Frame")
    Progress.Name = "Progress"
    Progress.Size = UDim2.new(0, 0, 1, 0)
    Progress.BackgroundColor3 = theme.SliderProgress
    Progress.BorderSizePixel = 0
    Progress.Parent = ProgressBackground

    local ProgressCorner2 = Instance.new("UICorner")
    ProgressCorner2.CornerRadius = UDim.new(1, 0)
    ProgressCorner2.Parent = Progress
    
    local Dragger = Instance.new("Frame")
    Dragger.Name = "Dragger"
    Dragger.Size = UDim2.new(0, 12, 0, 12)
    Dragger.Position = UDim2.new(0, -6, 0.5, -6)
    Dragger.BackgroundColor3 = theme.SliderBackground
    Dragger.BorderColor3 = theme.SliderStroke
    Dragger.BorderSizePixel = 1
    Dragger.Parent = Progress
    
    local DraggerCorner = Instance.new("UICorner")
    DraggerCorner.CornerRadius = UDim.new(1, 0)
    DraggerCorner.Parent = Dragger

    local dragging = false
    
    local function setValue(value)
        value = math.clamp(value, min, max)
        if rounding > 0 then
            value = math.round(value / rounding) * rounding
        end
        currentValue = value
        
        local ratio = (value - min) / (max - min)
        Progress.Size = UDim2.new(ratio, 0, 1, 0)
        ValueLabel.Text = string.format("%." .. rounding .. "f%s", value, suffix)
        
        if type(callback) == "function" then callback(value) end
    end
    
    local function onDrag(input)
        local backgroundAbsoluteX = ProgressBackground.AbsolutePosition.X
        local backgroundAbsoluteWidth = ProgressBackground.AbsoluteSize.X
        
        local x = math.clamp(input.Position.X - backgroundAbsoluteX, 0, backgroundAbsoluteWidth)
        local ratio = x / backgroundAbsoluteWidth
        local newValue = min + ratio * (max - min)
        
        setValue(newValue)
    end
    
    SliderFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            onDrag(input)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then onDrag(input) end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)
    
    setValue(currentValue)
    
    SliderFrame.Parent = group.Frame
    group:UpdateLayout()

    return {
        Frame = SliderFrame,
        Set = function(value) setValue(value) end,
        Get = function() return currentValue end
    }
end

local LibraryObjects = {}

local function NewGroup(tab, name)
    local theme = getTheme()
    
    local Group = Instance.new("Frame")
    Group.Name = name
    Group.Size = UDim2.new(0, 280, 1, 0)
    Group.BackgroundColor3 = Color3.fromRGB(22, 22, 22)
    Group.BorderColor3 = Color3.fromRGB(35, 35, 35)
    Group.BorderSizePixel = 1
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 6)
    Corner.Parent = Group

    local Title = Instance.new("TextLabel")
    Title.Text = name
    Title.TextColor3 = theme.TextColor
    Title.BackgroundTransparency = 1
    Title.Size = UDim2.new(1, 0, 0, 20)
    Title.Font = Enum.Font.SourceSans
    Title.TextSize = 16
    Title.Parent = Group
    
    local Scroller = Instance.new("ScrollingFrame")
    Scroller.Size = UDim2.new(1, 0, 1, -20)
    Scroller.Position = UDim2.new(0, 0, 0, 20)
    Scroller.BackgroundTransparency = 1
    Scroller.BorderSizePixel = 0
    Scroller.CanvasSize = UDim2.new(0, 0, 0, 0)
    Scroller.ScrollBarImageColor3 = theme.SliderBackground
    Scroller.ScrollBarThickness = 6
    Scroller.Parent = Group
    
    local ListLayout = Instance.new("UIListLayout")
    ListLayout.Padding = UDim.new(0, 4)
    ListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    ListLayout.VerticalAlignment = Enum.VerticalAlignment.Top
    ListLayout.Parent = Scroller
    
    local Padding = Instance.new("UIPadding")
    Padding.PaddingTop = UDim.new(0, 4)
    Padding.PaddingBottom = UDim.new(0, 4)
    Padding.Parent = Scroller

    local LayoutUpdater = Instance.new("Frame")
    LayoutUpdater.Name = "LayoutUpdater"
    LayoutUpdater.Size = UDim2.new(1, 0, 0, 0)
    LayoutUpdater.BackgroundTransparency = 1
    LayoutUpdater.Parent = Scroller

    local GroupObject = {
        Frame = LayoutUpdater,
        Layout = ListLayout,
        UpdateLayout = function(self)
            local contentHeight = 0
            for _, child in pairs(self.Frame:GetChildren()) do
                if child:IsA("Frame") or child:IsA("TextLabel") then
                    contentHeight = contentHeight + child.Size.Y.Offset + self.Layout.Padding.Offset
                end
            end
            Scroller.CanvasSize = UDim2.new(0, 0, 0, contentHeight + 8)
        end,
        NewToggle = function(self, ...) return NewToggle(self, ...) end,
        NewSlider = function(self, ...) return NewSlider(self, ...) end,
        NewButton = function(self, ...) return NewButton(self, ...) end,
    }
    
    table.insert(tab.Groups, Group)
    Group.Parent = tab.ContentFrame
    
    local groupCount = #tab.Groups
    local spaceX = 10
    local totalWidth = (Group.Size.X.Offset * groupCount) + (spaceX * (groupCount - 1))
    
    Group.Position = UDim2.new(0, (Group.Size.X.Offset + spaceX) * (groupCount - 1) + 10, 0, 10)
    tab.ContentFrame.CanvasSize = UDim2.new(0, totalWidth + 20, 0, 0)
    
    return GroupObject
end

local function NewTab(library, name, iconId)
    local theme = getTheme()
    
    local TabButton = Instance.new("TextButton")
    TabButton.Name = "TabButton"
    TabButton.Text = ""
    TabButton.Size = UDim2.new(1, 0, 0, 50)
    TabButton.BackgroundColor3 = theme.TabBackground
    TabButton.BorderColor3 = theme.TabStroke
    TabButton.BorderSizePixel = 1
    
    local TabCorner = Instance.new("UICorner")
    TabCorner.CornerRadius = UDim.new(0, 6)
    TabCorner.Parent = TabButton
    
    local Icon = Instance.new("ImageLabel")
    Icon.Image = "rbxassetid://" .. tostring(iconId or 0)
    Icon.ImageColor3 = theme.TabTextColor
    Icon.BackgroundTransparency = 1
    Icon.Size = UDim2.new(0, 30, 0, 30)
    Icon.Position = UDim2.new(0.5, -15, 0, 5)
    Icon.Parent = TabButton
    
    local Title = Instance.new("TextLabel")
    Title.Text = name
    Title.TextColor3 = theme.TabTextColor
    Title.BackgroundTransparency = 1
    Title.Size = UDim2.new(1, 0, 0, 15)
    Title.Position = UDim2.new(0.5, 0, 0, 35)
    Title.Font = Enum.Font.SourceSans
    Title.TextSize = 12
    Title.Parent = TabButton
    
    local Indicator = Instance.new("Frame")
    Indicator.Name = "Indicator"
    Indicator.Size = UDim2.new(1, 0, 0, 4)
    Indicator.BackgroundColor3 = theme.SliderBackground
    Indicator.Position = UDim2.new(0, 0, 1, -4)
    Indicator.BorderSizePixel = 0
    Indicator.Parent = TabButton
    
    local ContentFrame = Instance.new("ScrollingFrame")
    ContentFrame.Name = "ContentFrame"
    ContentFrame.Size = UDim2.new(1, -210, 1, -30)
    ContentFrame.Position = UDim2.new(0, 200, 0, 30)
    ContentFrame.BackgroundTransparency = 1
    ContentFrame.BorderSizePixel = 0
    ContentFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    ContentFrame.ScrollBarImageColor3 = theme.SliderBackground
    ContentFrame.ScrollBarThickness = 6
    ContentFrame.Parent = library.Container
    ContentFrame.Visible = false
    
    local ContentCorner = Instance.new("UICorner")
    ContentCorner.CornerRadius = UDim.new(0, 6)
    ContentCorner.Parent = ContentFrame
    
    local TabObject = {
        Button = TabButton,
        ContentFrame = ContentFrame,
        Icon = Icon,
        Title = Title,
        Indicator = Indicator,
        Groups = {},
        NewGroup = function(self, ...) return NewGroup(self, ...) end
    }
    
    table.insert(library.Tabs, TabObject)
    TabButton.Parent = library.SidebarFrame
    
    local function selectTab()
        for _, tab in pairs(library.Tabs) do
            local isSelected = (tab == TabObject)
            local targetBG = isSelected and theme.TabBackgroundSelected or theme.TabBackground
            local targetTitleColor = isSelected and theme.SelectedTabTextColor or theme.TabTextColor
            local targetIconColor = isSelected and theme.SliderBackground or theme.TabTextColor
            local targetIndicatorAlpha = isSelected and 1 or 0
            
            TweenService:Create(tab.Button, TweenInfo.new(0.2), {BackgroundColor3 = targetBG}):Play()
            TweenService:Create(tab.Title, TweenInfo.new(0.2), {TextColor3 = targetTitleColor}):Play()
            TweenService:Create(tab.Icon, TweenInfo.new(0.2), {ImageColor3 = targetIconColor}):Play()
            TweenService:Create(tab.Indicator, TweenInfo.new(0.2), {BackgroundTransparency = 1 - targetIndicatorAlpha}):Play()
            
            tab.ContentFrame.Visible = isSelected
        end
    end
    
    TabButton.MouseButton1Click:Connect(selectTab)
    
    if #library.Tabs == 1 then selectTab() end
    
    return TabObject
end

local function CreateLib(name, options)
    local theme = getTheme()
    options = options or {}
    LibraryToggleKey = options.ToggleKey or Enum.KeyCode.RightControl

    local Container = Instance.new('Frame', Library)
    Container.Name = 'Container'
    Container.Size = UDim2.new(1, 0, 1, 0)
    Container.Position = UDim2.new(0, 0, 0, 0)
    Container.BackgroundColor3 = theme.Background
    Container.BorderColor3 = theme.ElementStroke
    Container.BorderSizePixel = 1

    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 8)
    Corner.Parent = Container

    local Topbar = Instance.new('Frame', Container)
    Topbar.Name = 'Topbar'
    Topbar.Size = UDim2.new(1, 0, 0, 20)
    Topbar.BackgroundColor3 = theme.Topbar
    Topbar.BorderSizePixel = 0
    
    local Title = Instance.new('TextLabel', Topbar)
    Title.Text = name .. " | " .. Release
    Title.TextColor3 = theme.TextColor
    Title.BackgroundTransparency = 1
    Title.Size = UDim2.new(1, 0, 1, 0)
    Title.Font = Enum.Font.SourceSans
    Title.TextSize = 14

    local SidebarFrame = Instance.new('Frame', Container)
    SidebarFrame.Name = 'Sidebar'
    SidebarFrame.Size = UDim2.new(0, 180, 1, -30)
    SidebarFrame.Position = UDim2.new(0, 10, 0, 20)
    SidebarFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
    SidebarFrame.BorderSizePixel = 0
    
    local SidebarLayout = Instance.new('UIListLayout', SidebarFrame)
    SidebarLayout.Padding = UDim.new(0, 8)
    SidebarLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    SidebarLayout.VerticalAlignment = Enum.VerticalAlignment.Top

    local SidebarPadding = Instance.new('UIPadding', SidebarFrame)
    SidebarPadding.PaddingTop = UDim.new(0, 10)
    SidebarPadding.PaddingBottom = UDim.new(0, 10)

    local dragging = false
    local dragStart = nil
    local startPos = nil

    Topbar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = Main.Position
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)
    
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == LibraryToggleKey then
            Library.Visible = not Library.Visible
            local targetAlpha = Library.Visible and 0 or 1
            TweenService:Create(Library, TweenInfo.new(0.3), {BackgroundTransparency = targetAlpha}):Play()
        end
    end)

    local LibObject = {
        MainFrame = Main,
        LibraryFrame = Library,
        Container = Container,
        SidebarFrame = SidebarFrame,
        Tabs = {},
        NewTab = function(self, ...) return NewTab(self, ...) end,
    }

    RayfieldLibrary.LibraryObject = LibObject
    Library.Visible = true
    applyTheme()
    
    TweenService:Create(Library, TweenInfo.new(0.3), {BackgroundTransparency = 0}):Play()

    return LibObject
end

RayfieldLibrary.CreateLib = CreateLib
RayfieldLibrary.Notify = function(options) warn("Notification triggered (Title:", options.Title, ", Content:", options.Content, ")") end
RayfieldLibrary.LoadConfiguration = function() end

return RayfieldLibrary
