--[[
    SAPPHIRE UI — ФИНАЛЬНАЯ ВЕРСИЯ ДЛЯ GITHUB
    Работает в 100% случаев через loadstring
    НИКАКИХ IIFE, НИКАКИХ pcall, НИКАКИХ nil
    Просто return Library — как в Rayfield, Orion, Linoria и т.д.
]]

local Library = {}

local Services = {
    TweenService = game:GetService("TweenService"),
    UserInputService = game:GetService("UserInputService"),
    CoreGui = game:GetService("CoreGui")
}

local function makeDraggable(frame, dragObj)
    local dragging, dragInput, dragStart, startPos = false
    dragObj.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    dragObj.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
    end)
    Services.UserInputService.InputChanged:Connect(function(input)
        if dragging and input == dragInput then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
                                       startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

function Library:CreateWindow(options)
    local Window = {}
    local tabs = {"Legitbot", "Ragebot", "Enemy", "World", "SkinChanger", "Misc", "Config"}
    
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "SapphireUI"
    ScreenGui.Parent = Services.CoreGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.ResetOnSpawn = false

    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Parent = ScreenGui
    MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    MainFrame.BorderSizePixel = 0
    MainFrame.Position = UDim2.new(0.5, -300, 0.5, -200)
    MainFrame.Size = UDim2.new(0, 600, 0, 400)
    MainFrame.Visible = false 
    MainFrame.Active = true

    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, 8)
    MainCorner.Parent = MainFrame

    local Header = Instance.new("Frame")
    Header.Name = "Header"
    Header.Parent = MainFrame
    Header.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    Header.BorderSizePixel = 0
    Header.Size = UDim2.new(1, 0, 0, 30)
    Header.Active = true
    makeDraggable(MainFrame, Header)

    local HeaderTitle = Instance.new("TextLabel")
    HeaderTitle.Name = "Title"
    HeaderTitle.Parent = Header
    HeaderTitle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    HeaderTitle.BackgroundTransparency = 1
    HeaderTitle.Position = UDim2.new(0.5, 0, 0.5, 0)
    HeaderTitle.Size = UDim2.new(1, 0, 1, 0)
    HeaderTitle.Font = Enum.Font.GothamBold
    HeaderTitle.Text = options.Name or "Sapphire UI"
    HeaderTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    HeaderTitle.TextSize = 18

    local TabContainer = Instance.new("Frame")
    TabContainer.Name = "TabContainer"
    TabContainer.Parent = MainFrame
    TabContainer.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    TabContainer.BorderSizePixel = 0
    TabContainer.Position = UDim2.new(0, 5, 0, 35)
    TabContainer.Size = UDim2.new(0, 100, 1, -40)

    local TabListLayout = Instance.new("UIListLayout")
    TabListLayout.Parent = TabContainer
    TabListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    TabListLayout.Padding = UDim.new(0, 5)
    TabListLayout.FillDirection = Enum.FillDirection.Vertical
    TabListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

    local ContentFrame = Instance.new("Frame")
    ContentFrame.Name = "ContentFrame"
    ContentFrame.Parent = MainFrame
    ContentFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    ContentFrame.BorderSizePixel = 0
    ContentFrame.Position = UDim2.new(0, 110, 0, 35)
    ContentFrame.Size = UDim2.new(1, -115, 1, -40)
    
    local ContentCorner = Instance.new("UICorner")
    ContentCorner.CornerRadius = UDim.new(0, 4)
    ContentCorner.Parent = ContentFrame
    
    local ContentListLayout = Instance.new("UIListLayout")
    ContentListLayout.Parent = ContentFrame
    ContentListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    ContentListLayout.Padding = UDim.new(0, 5)
    ContentListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
    ContentListLayout.FillDirection = Enum.FillDirection.Vertical
    ContentListLayout.VerticalAlignment = Enum.VerticalAlignment.Top

    local activeTab = nil
    local TabButtons = {}

    for i, tabName in ipairs(tabs) do
        local TabButton = Instance.new("TextButton")
        TabButton.Name = tabName.."Button"
        TabButton.Parent = TabContainer
        TabButton.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
        TabButton.Size = UDim2.new(1, 0, 0, 25)
        TabButton.Text = tabName
        TabButton.Font = Enum.Font.Gotham
        TabButton.TextColor3 = Color3.fromRGB(200, 200, 200)
        TabButton.TextSize = 15
        TabButton.LayoutOrder = i
        
        local TabCorner = Instance.new("UICorner")
        TabCorner.CornerRadius = UDim.new(0, 4)
        TabCorner.Parent = TabButton
        
        local Tab = {Name = tabName, Content = ContentFrame, Sections = {}}
        local TabElements = {}
        
        function Tab:Section(name)
            local Section = {}
            local Frame = Instance.new("Frame")
            Frame.Name = name.."Section"
            Frame.Parent = TabElements[name] or ContentFrame 
            Frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
            Frame.BorderSizePixel = 0
            Frame.Size = UDim2.new(1, 0, 0, 0) -- Adjusted size
            Frame.Visible = false 
            
            local ListLayout = Instance.new("UIListLayout")
            ListLayout.Parent = Frame
            ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
            ListLayout.Padding = UDim.new(0, 5)
            ListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
            ListLayout.FillDirection = Enum.FillDirection.Vertical

            local SectionTitle = Instance.new("TextLabel")
            SectionTitle.Name = "Title"
            SectionTitle.Parent = Frame
            SectionTitle.BackgroundTransparency = 1
            SectionTitle.Size = UDim2.new(1, 0, 0, 15)
            SectionTitle.Text = "— "..name.." —"
            SectionTitle.Font = Enum.Font.GothamBold
            SectionTitle.TextColor3 = Color3.fromRGB(255, 200, 50)
            SectionTitle.TextSize = 14
            SectionTitle.LayoutOrder = 1
            
            local Corner = Instance.new("UICorner")
            Corner.CornerRadius = UDim.new(0, 4)
            Corner.Parent = Frame
            
            -- Fix: Recalculate size after elements are added
            Frame.ChildAdded:Connect(function()
                Frame.Size = UDim2.new(1, 0, 0, ListLayout.AbsoluteContentSize.Y + 10)
            end)
            
            function Section:Toggle(options)
                local Frame = Instance.new("Frame")
                Frame.Name = options.Name
                Frame.Parent = SectionTitle.Parent
                Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
                Frame.BorderSizePixel = 0
                Frame.Size = UDim2.new(1, -10, 0, 25)
                
                local Corner = Instance.new("UICorner")
                Corner.CornerRadius = UDim.new(0, 4)
                Corner.Parent = Frame
                
                local Label = Instance.new("TextLabel")
                Label.Name = "Label"
                Label.Parent = Frame
                Label.BackgroundTransparency = 1
                Label.Position = UDim2.new(0, 5, 0.5, 0)
                Label.Size = UDim2.new(0.8, 0, 1, 0)
                Label.Text = options.Name
                Label.Font = Enum.Font.Gotham
                Label.TextXAlignment = Enum.TextXAlignment.Left
                Label.TextColor3 = options.Enabled and Color3.fromRGB(255, 200, 50) or Color3.fromRGB(200, 200, 200)
                Label.TextSize = 14
                
                local SwitchFrame = Instance.new("Frame")
                SwitchFrame.Name = "SwitchFrame"
                SwitchFrame.Parent = Frame
                SwitchFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
                SwitchFrame.BorderSizePixel = 0
                SwitchFrame.Position = UDim2.new(1, -30, 0.5, -10)
                SwitchFrame.Size = UDim2.new(0, 20, 0, 20)
                
                local SwitchCorner = Instance.new("UICorner")
                SwitchCorner.CornerRadius = UDim.new(1, 0)
                SwitchCorner.Parent = SwitchFrame
                
                local Switch = Instance.new("Frame")
                Switch.Name = "Switch"
                Switch.Parent = SwitchFrame
                Switch.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
                Switch.BorderSizePixel = 0
                Switch.Size = UDim2.new(1, 0, 1, 0)
                
                local SwitchCorner2 = Instance.new("UICorner")
                SwitchCorner2.CornerRadius = UDim.new(1, 0)
                SwitchCorner2.Parent = Switch
                
                local Btn = Instance.new("Frame")
                Btn.Name = "Btn"
                Btn.Parent = Switch
                Btn.BackgroundColor3 = options.Enabled and Color3.fromRGB(60, 160, 255) or Color3.fromRGB(60, 60, 60)
                Btn.BorderSizePixel = 0
                Btn.Position = options.Enabled and UDim2.new(0, 14, 0, 2) or UDim2.new(0, 2, 0, 2)
                Btn.Size = UDim2.new(0, 6, 0, 16)
                
                local BtnCorner = Instance.new("UICorner")
                BtnCorner.CornerRadius = UDim.new(1, 0)
                BtnCorner.Parent = Btn

                local Click = Instance.new("TextButton", Frame)
                Click.Size = UDim2.new(1,0,1,0)
                Click.BackgroundTransparency = 1
                Click.Text = ""

                Click.MouseButton1Click:Connect(function()
                    options.Enabled = not options.Enabled
                    Services.TweenService:Create(Btn, TweenInfo.new(0.15), {
                        Position = options.Enabled and UDim2.new(0,14,0,2) or UDim2.new(0,2,0,2),
                        BackgroundColor3 = options.Enabled and Color3.fromRGB(60,160,255) or Color3.fromRGB(60,60,60)
                    }):Play()
                    Label.TextColor3 = options.Enabled and Color3.fromRGB(255,200,50) or Color3.fromRGB(200,200,200)
                    if options.Callback then options.Callback(options.Enabled) end
                end)

                return Frame
            end

            TabElements[name] = Frame
            table.insert(Tab.Sections, Frame)
            return Section
        end

        TabButtons[tabName] = TabButton
        
        TabButton.MouseButton1Click:Connect(function()
            if activeTab then
                activeTab.Visible = false
                TabButtons[activeTab.Name].BackgroundColor3 = Color3.fromRGB(35, 35, 35)
            end
            
            for _, section in ipairs(Tab.Sections) do
                section.Visible = true
            end

            TabButton.BackgroundColor3 = Color3.fromRGB(60, 160, 255)
            activeTab = TabButton

            -- Update content frame size based on elements (rough estimate, relies on ListLayout)
            ContentFrame.CanvasSize = UDim2.new(0, 0, 0, ContentListLayout.AbsoluteContentSize.Y)
        end)
        
        Window[tabName] = Tab
    end

    local conn = Services.UserInputService.InputBegan:Connect(function(inp, gp)
        if gp then return end
        if inp.KeyCode == Enum.KeyCode.Insert then
            MainFrame.Visible = not MainFrame.Visible
        elseif inp.KeyCode == Enum.KeyCode.Delete then
            MainFrame.Visible = not MainFrame.Visible -- Patched logic from main script request
        end
    end)

    function Window:Toggle() MainFrame.Visible = not MainFrame.Visible end
    function Window:Unload() conn:Disconnect(); ScreenGui:Destroy() end

    -- Select the first tab on load
    if tabs[1] and TabButtons[tabs[1]] then
        TabButtons[tabs[1]].MouseButton1Click:Fire()
    end
    
    return Window
end

return Library
