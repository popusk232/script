-- CrimLib.lua
-- Модуль содержит ТОЛЬКО логику создания и визуального обновления GUI.

local CrimLib = {}

-- Services
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

-- GUI Constants
local COLOR_MAIN = Color3.fromRGB(25, 25, 25)
local COLOR_TOPBAR = Color3.fromRGB(35, 35, 35)
local COLOR_SIDEBAR = Color3.fromRGB(45, 45, 45)
local COLOR_ACCENT = Color3.fromRGB(70, 200, 70) 
local COLOR_OFF = Color3.fromRGB(35, 35, 35)    
local COLOR_TEXT = Color3.fromRGB(255, 255, 255)
local COLOR_BINDING = Color3.fromRGB(255, 165, 0) 
local FONT = Enum.Font.Gotham

-- Local State
local CurrentTab = nil

-- === Utility Functions (для прозрачности) ===

local function recursiveSetTransparency(gui, opacity)
    local targetTransparency = 1 - opacity
    for _, child in pairs(gui:GetDescendants()) do
        if child:IsA("GuiObject") and not child:IsA("ScreenGui") then
            if child.Name ~= "SliderHandle" and child.Name ~= "KeybindButton" then
                if child.BackgroundTransparency < 1 then
                    child.BackgroundTransparency = targetTransparency
                end
                if child:IsA("TextLabel") or child:IsA("TextButton") then
                    child.TextTransparency = targetTransparency
                end
            end
        end
    end
end

-- === Core GUI Setup Functions ===

function CrimLib.Init()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "CrimsonGui"
    ScreenGui.Parent = CoreGui

    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Parent = ScreenGui
    MainFrame.BackgroundColor3 = COLOR_MAIN
    MainFrame.Position = UDim2.new(0.5, -200, 0.5, -250)
    MainFrame.Size = UDim2.new(0, 400, 0, 500)
    MainFrame.Active = true
    MainFrame.Draggable = true
    MainFrame.Visible = false
    Instance.new("UICorner").Parent = MainFrame

    local TopBar = Instance.new("Frame")
    TopBar.Name = "TopBar"
    TopBar.Parent = MainFrame
    TopBar.BackgroundColor3 = COLOR_TOPBAR
    TopBar.Size = UDim2.new(1, 0, 0, 30)

    local Sidebar = Instance.new("Frame")
    Sidebar.Name = "Sidebar"
    Sidebar.Parent = MainFrame
    Sidebar.BackgroundColor3 = COLOR_SIDEBAR
    Sidebar.Position = UDim2.new(0, 0, 0, 30)
    Sidebar.Size = UDim2.new(0, 100, 1, -60)
    
    local TabContentFrame = Instance.new("Frame")
    TabContentFrame.Name = "TabContentFrame"
    TabContentFrame.Parent = MainFrame
    TabContentFrame.BackgroundColor3 = COLOR_TOPBAR
    TabContentFrame.Position = UDim2.new(0, 100, 0, 30)
    TabContentFrame.Size = UDim2.new(1, -100, 1, -60)
    
    local UIListLayout = Instance.new("UIListLayout")
    UIListLayout.Parent = TabContentFrame
    UIListLayout.Padding = UDim.new(0, 10)
    UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    
    local UIPadding = Instance.new("UIPadding")
    UIPadding.Parent = TabContentFrame
    UIPadding.PaddingTop = UDim.new(0, 10)
    UIPadding.PaddingBottom = UDim.new(0, 10)
    UIPadding.PaddingLeft = UDim.new(0, 10)
    UIPadding.PaddingRight = UDim.new(0, 10)

    local Layout = Instance.new("UIListLayout")
    Layout.Parent = Sidebar
    Layout.Padding = UDim.new(0, 5)
    Layout.SortOrder = Enum.SortOrder.LayoutOrder

    return MainFrame, Sidebar, TabContentFrame, ScreenGui
end

function CrimLib.CreateTabContent(name)
    local frame = Instance.new("Frame")
    frame.Name = name .. "Content"
    frame.BackgroundColor3 = COLOR_TOPBAR
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.Visible = false
    frame.LayoutOrder = 1
    
    local ListLayout = Instance.new("UIListLayout")
    ListLayout.Parent = frame
    ListLayout.Padding = UDim.new(0, 10)
    ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    
    return frame
end

function CrimLib.CreateTabButton(name, sidebar, index, tabContent)
    local button = Instance.new("TextButton")
    button.Name = name .. "Tab"
    button.Parent = sidebar
    button.BackgroundColor3 = COLOR_SIDEBAR
    button.Size = UDim2.new(1, 0, 0, 30)
    button.Font = FONT
    button.Text = name
    button.TextColor3 = COLOR_TEXT
    button.TextSize = 14
    button.LayoutOrder = index
    
    button.MouseButton1Click:Connect(function()
        CrimLib.SwitchTab(tabContent, button)
    end)

    return button
end

function CrimLib.SwitchTab(tab, button)
    if CurrentTab then
        CurrentTab.Visible = false
        if CurrentTab.TabButton then
            CurrentTab.TabButton.BackgroundColor3 = COLOR_SIDEBAR
        end
    end
    tab.Visible = true
    tab.TabButton = button
    if button then
        button.BackgroundColor3 = COLOR_ACCENT
    end
    CurrentTab = tab
end

function CrimLib.UpdateToggleVisuals(toggleButton, statusLabel, newState)
    local newColor = newState and COLOR_ACCENT or COLOR_OFF
    TweenService:Create(toggleButton, TweenInfo.new(0.15), {BackgroundColor3 = newColor}):Play()
    statusLabel.Text = newState and "ON" or "OFF"
    statusLabel.TextColor3 = newState and COLOR_ACCENT or COLOR_OFF
end

function CrimLib.CreateButton(parent, name, layoutOrder, stateRef, stateKey, toggleCallback)
    local Toggle = Instance.new("TextButton")
    Toggle.Name = name:gsub("%s", ""):gsub("%-", "") .. "Toggle"
    Toggle.Parent = parent
    Toggle.BackgroundColor3 = stateRef[stateKey] and COLOR_ACCENT or COLOR_OFF
    Toggle.Size = UDim2.new(1, 0, 0, 30)
    Toggle.Font = FONT
    Toggle.Text = " " .. name
    Toggle.TextColor3 = COLOR_TEXT
    Toggle.TextSize = 14
    Toggle.TextXAlignment = Enum.TextXAlignment.Left
    Toggle.LayoutOrder = layoutOrder
    Instance.new("UICorner").Parent = Toggle

    local Status = Instance.new("TextLabel")
    Status.Name = "Status"
    Status.Parent = Toggle
    Status.BackgroundTransparency = 1
    Status.Position = UDim2.new(1, -60, 0, 0)
    Status.Size = UDim2.new(0, 60, 1, 0)
    Status.Font = Enum.Font.GothamBold
    Status.TextColor3 = COLOR_TEXT
    Status.TextSize = 14
    Status.TextXAlignment = Enum.TextXAlignment.Right
    
    CrimLib.UpdateToggleVisuals(Toggle, Status, stateRef[stateKey])
    
    Toggle.MouseButton1Click:Connect(function()
        toggleCallback()
        local newState = stateRef[stateKey]
        CrimLib.UpdateToggleVisuals(Toggle, Status, newState)
    end)

    Toggle.updateVisuals = function(newState)
        CrimLib.UpdateToggleVisuals(Toggle, Status, newState)
    end
    
    return Toggle
end

function CrimLib.CreateSlider(parent, name, layoutOrder, minVal, maxVal, valueRef, valueKey, updateCallback)
    local Frame = Instance.new("Frame")
    Frame.Name = name:gsub("%s", ""):gsub("%-", "") .. "SliderFrame"
    Frame.Parent = parent
    Frame.BackgroundColor3 = COLOR_OFF
    Frame.Size = UDim2.new(1, 0, 0, 40)
    Frame.LayoutOrder = layoutOrder
    Instance.new("UICorner").Parent = Frame
    
    local Label = Instance.new("TextLabel")
    Label.Parent = Frame
    Label.BackgroundTransparency = 1
    Label.Position = UDim2.new(0, 0, 0, 0)
    Label.Size = UDim2.new(1, 0, 0, 15)
    Label.Font = FONT
    Label.TextColor3 = COLOR_TEXT
    Label.TextSize = 12
    Label.TextXAlignment = Enum.TextXAlignment.Left
    
    local SliderBackground = Instance.new("Frame")
    SliderBackground.Name = "SliderBackground"
    SliderBackground.Parent = Frame
    SliderBackground.BackgroundColor3 = COLOR_MAIN
    SliderBackground.Position = UDim2.new(0.05, 0, 0.5, 0)
    SliderBackground.Size = UDim2.new(0.9, 0, 0, 10)
    Instance.new("UICorner").Parent = SliderBackground
    
    local SliderBar = Instance.new("Frame")
    SliderBar.Name = "SliderBar"
    SliderBar.Parent = SliderBackground
    SliderBar.BackgroundColor3 = COLOR_ACCENT
    SliderBar.Position = UDim2.new(0, 0, 1, 0)
    
    local Handle = Instance.new("Frame")
    Handle.Name = "SliderHandle"
    Handle.Parent = SliderBar
    Handle.BackgroundColor3 = COLOR_TEXT
    Handle.Size = UDim2.new(0, 10, 0, 10)
    Handle.Position = UDim2.new(1, -5, 0.5, -5)
    Handle.ZIndex = 2
    Handle.Active = true
    Instance.new("UICorner").Parent = Handle
    
    local isDragging = false
    
    local function updateVisuals(newValue)
        local newRatio = (newValue - minVal) / (maxVal - minVal)
        SliderBar.Size = UDim2.new(newRatio, 0, 1, 0)
        local displayValue = math.floor(newValue * 10) / 10
        Label.Text = name .. " (" .. tostring(displayValue) .. ")"
    end

    local function updateSlider(input)
        local inputX = input.Position.X
        local framePos = SliderBackground.AbsolutePosition.X
        local frameSize = SliderBackground.AbsoluteSize.X
        
        local relativeX = math.min(math.max(inputX - framePos, 0), frameSize)
        local ratio = relativeX / frameSize
        local newValue = minVal + ratio * (maxVal - minVal)
        newValue = math.floor(newValue * 100) / 100 
        
        valueRef[valueKey] = newValue 
        updateVisuals(newValue)
        
        if updateCallback then
            updateCallback(newValue)
        end
    end
    
    Handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = true
            updateSlider(input)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            updateSlider(input)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = false
        end
    end)

    Frame.updateVisuals = updateVisuals
    updateVisuals(valueRef[valueKey])
    
    return Frame
end

function CrimLib.CreateKeybindButton(parent, name, layoutOrder, keybindRef, keybindKey, captureVarRef)
    local Frame = Instance.new("Frame")
    Frame.Name = name:gsub("%s", ""):gsub("%-", "") .. "KeybindFrame"
    Frame.Parent = parent
    Frame.BackgroundTransparency = 1
    Frame.Size = UDim2.new(1, 0, 0, 30)
    Frame.LayoutOrder = layoutOrder
    
    local Label = Instance.new("TextLabel")
    Label.Parent = Frame
    Label.BackgroundTransparency = 1
    Label.Position = UDim2.new(0, 0, 0, 0)
    Label.Size = UDim2.new(0, 200, 1, 0)
    Label.Font = FONT
    Label.TextColor3 = COLOR_TEXT
    Label.TextSize = 14
    Label.TextXAlignment = Enum.TextXAlignment.Left

    local Button = Instance.new("TextButton")
    Button.Name = "KeybindButton"
    Button.Parent = Frame
    Button.BackgroundColor3 = COLOR_OFF
    Button.Position = UDim2.new(1, -100, 0, 0)
    Button.Size = UDim2.new(0, 100, 1, 0)
    Button.Font = FONT
    Button.TextColor3 = COLOR_TEXT
    Button.TextSize = 14
    Instance.new("UICorner").Parent = Button
    
    local function updateVisuals()
        Label.Text = name .. " (Current: " .. keybindRef[keybindKey] .. ")"
        Button.Text = "BIND"
        Button.BackgroundColor3 = COLOR_OFF
    end
    
    Button.MouseButton1Click:Connect(function()
        if captureVarRef.value then return end
        captureVarRef.value = true
        Button.Text = "..."
        Button.BackgroundColor3 = COLOR_BINDING
        
        local connection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
            if gameProcessed or input.UserInputType ~= Enum.UserInputType.Keyboard then return end
            
            keybindRef[keybindKey] = input.KeyCode.Name
            captureVarRef.value = false
            connection:Disconnect()
            updateVisuals()
        end)
    end)

    Frame.updateVisuals = updateVisuals
    updateVisuals()
    
    return Frame
end

function CrimLib.ApplyOpacity(mainFrame, opacity)
    recursiveSetTransparency(mainFrame, opacity)
end

return CrimLib
