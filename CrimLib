--[[
Полный код CrimLib, адаптированный для функционала ESP и AimBot.
Он включает все необходимые функции для создания UI (Toggle, Slider, Dropdown, Keybind, ColorPicker)
и логику переключения вкладок.
]]

local CrimLib = {}
local connections = {}
local tweenService = game:GetService("TweenService")
local userInputService = game:GetService("UserInputService")
local CoreGui = game:FindFirstChild('CoreGui')
local ScreenGui
local UnloadCallbacks = {}
local MainFrame 
local Title
local ContentFrame
local SidebarFrame
local CurrentTabName = "CombatLeft" -- Начальная вкладка

-- Хранилище для вкладок и колонок
CrimLib.Tabs = {}
CrimLib.yOffsets = {
    CombatLeft = 10,
    CombatRight = 10,
    EnemyLeft = 10,
    EnemyRight = 10,
    Settings = 40
}

-- [[ ВНУТРЕННИЕ ФУНКЦИИ ОТРИСОВКИ ]]

local function internalCreateToggle(parent, yPos, label, enabled, callback)
    local toggleState = enabled
    
    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Parent = parent
    ToggleFrame.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
    ToggleFrame.BorderSizePixel = 0
    ToggleFrame.Position = UDim2.new(0, 15, 0, yPos)
    ToggleFrame.Size = UDim2.new(1, -30, 0, 30)
    ToggleFrame.ClipsDescendants = false
    ToggleFrame.ZIndex = 5
    ToggleFrame:SetAttribute("HasBackground", true) 

    local ToggleCorner = Instance.new("UICorner")
    ToggleCorner.CornerRadius = UDim.new(0, 4)
    ToggleCorner.Parent = ToggleFrame
    
    local Label = Instance.new("TextLabel")
    Label.Parent = ToggleFrame
    Label.BackgroundTransparency = 1
    Label.Position = UDim2.new(0, 12, 0, 0)
    Label.Size = UDim2.new(0, 200, 1, 0)
    Label.Font = Enum.Font.Gotham
    Label.Text = label
    Label.TextColor3 = toggleState and Color3.fromRGB(255, 200, 50) or Color3.fromRGB(200, 200, 200)
    Label.TextSize = 13
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.ZIndex = 6
    
    local ToggleBg = Instance.new("Frame")
    ToggleBg.Parent = ToggleFrame
    ToggleBg.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ToggleBg.BorderSizePixel = 0
    ToggleBg.Position = UDim2.new(1, -38, 0.5, -10)
    ToggleBg.Size = UDim2.new(0, 32, 0, 20)
    ToggleBg.ZIndex = 6
    ToggleBg:SetAttribute("HasBackground", true) 

    local BgCorner = Instance.new("UICorner")
    BgCorner.CornerRadius = UDim.new(1, 0)
    BgCorner.Parent = ToggleBg
    
    local ToggleButton = Instance.new("Frame")
    ToggleButton.Parent = ToggleBg
    ToggleButton.BackgroundColor3 = toggleState and Color3.fromRGB(60, 160, 255) or Color3.fromRGB(60, 60, 60)
    ToggleButton.BorderSizePixel = 0
    ToggleButton.Position = toggleState and UDim2.new(0, 14, 0, 2) or UDim2.new(0, 2, 0, 2)
    ToggleButton.Size = UDim2.new(0, 16, 0, 16)
    ToggleButton.ZIndex = 7
    ToggleButton:SetAttribute("HasBackground", true) 

    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(1, 0)
    ButtonCorner.Parent = ToggleButton
    
    local ClickButton = Instance.new("TextButton")
    ClickButton.Parent = ToggleFrame
    ClickButton.BackgroundTransparency = 1
    ClickButton.Size = UDim2.new(1, 0, 1, 0)
    ClickButton.Text = ""
    ClickButton.ZIndex = 8
    
    table.insert(connections, ClickButton.MouseButton1Click:Connect(function()
        toggleState = not toggleState
        
        tweenService:Create(ToggleButton, TweenInfo.new(0.15, Enum.EasingStyle.Quad), {
            Position = toggleState and UDim2.new(0, 14, 0, 2) or UDim2.new(0, 2, 0, 2),
            BackgroundColor3 = toggleState and Color3.fromRGB(60, 160, 255) or Color3.fromRGB(60, 60, 60)
        }):Play()
        
        tweenService:Create(Label, TweenInfo.new(0.15, Enum.EasingStyle.Quad), {
            TextColor3 = toggleState and Color3.fromRGB(255, 200, 50) or Color3.fromRGB(200, 200, 200)
        }):Play()
        
        if callback then
            callback(toggleState)
        end
    end))
    
    table.insert(connections, ClickButton.MouseEnter:Connect(function()
        tweenService:Create(ToggleFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), { BackgroundColor3 = Color3.fromRGB(32, 32, 32) }):Play()
    end))
    
    table.insert(connections, ClickButton.MouseLeave:Connect(function()
        tweenService:Create(ToggleFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), { BackgroundColor3 = Color3.fromRGB(28, 28, 28) }):Play()
    end))

    return ToggleFrame, toggleState
end

local function internalCreateSlider(parent, yPos, label, defaultValue, minValue, maxValue, hasOverride, onValueChanged)
    local sliderValue = defaultValue
    local dragging = false
    local SliderFrame = Instance.new("Frame")
    SliderFrame.Parent = parent
    SliderFrame.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
    SliderFrame.BorderSizePixel = 0
    SliderFrame.Position = UDim2.new(0, 15, 0, yPos)
    SliderFrame.Size = UDim2.new(1, -30, 0, 30)
    SliderFrame:SetAttribute("HasBackground", true)

    local SliderCorner = Instance.new("UICorner")
    SliderCorner.CornerRadius = UDim.new(0, 4)
    SliderCorner.Parent = SliderFrame

    local Label = Instance.new("TextLabel")
    Label.Parent = SliderFrame
    Label.BackgroundTransparency = 1
    Label.Position = UDim2.new(0, 12, 0, 0)
    Label.Size = UDim2.new(0, 150, 1, 0)
    Label.Font = Enum.Font.Gotham
    Label.Text = label
    Label.TextColor3 = Color3.fromRGB(200, 200, 200)
    Label.TextSize = 13
    Label.TextXAlignment = Enum.TextXAlignment.Left

    local ValueLabel = Instance.new("TextLabel")
    ValueLabel.Parent = SliderFrame
    ValueLabel.BackgroundTransparency = 1
    ValueLabel.Position = UDim2.new(1, -35, 0, 0)
    ValueLabel.Size = UDim2.new(0, 38, 1, 0)
    ValueLabel.Font = Enum.Font.GothamBold
    ValueLabel.Text = tostring(defaultValue)
    ValueLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    ValueLabel.TextSize = 13
    ValueLabel.TextXAlignment = Enum.TextXAlignment.Right

    local SliderTrack = Instance.new("Frame")
    SliderTrack.Parent = SliderFrame
    SliderTrack.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    SliderTrack.BorderSizePixel = 0
    SliderTrack.Position = UDim2.new(0, hasOverride and 180 or 160, 0.5, -2)
    SliderTrack.Size = UDim2.new(1, hasOverride and -245 or -225, 0, 4)
    SliderTrack:SetAttribute("HasBackground", true)

    local TrackCorner = Instance.new("UICorner")
    TrackCorner.CornerRadius = UDim.new(0, 2)
    TrackCorner.Parent = SliderTrack

    local SliderFill = Instance.new("Frame")
    SliderFill.Parent = SliderTrack
    SliderFill.BackgroundColor3 = Color3.fromRGB(60, 160, 255)
    SliderFill.BorderSizePixel = 0
    SliderFill.Position = UDim2.new(0, 0, 0, 0)
    SliderFill.Size = UDim2.new(0, 0, 1, 0)
    SliderFill:SetAttribute("HasBackground", true)

    local SliderThumb = Instance.new("Frame")
    SliderThumb.Parent = SliderFill
    SliderThumb.BackgroundColor3 = Color3.fromRGB(60, 160, 255)
    SliderThumb.BorderSizePixel = 0
    SliderThumb.Position = UDim2.new(1, 0, 0.5, -5)
    SliderThumb.Size = UDim2.new(0, 10, 0, 10)
    SliderThumb.ZIndex = 2
    SliderThumb:SetAttribute("HasBackground", true)

    local function updateSlider(input)
        local mousePos = input.Position.X
        local trackAbsolutePos = SliderTrack.AbsolutePosition.X
        local trackSize = SliderTrack.AbsoluteSize.X
       
        local xOffset = math.clamp(mousePos - trackAbsolutePos, 0, trackSize)
        local percent = xOffset / trackSize
        
        local valueRange = maxValue - minValue
        local rawValue = minValue + (valueRange * percent)
        local newValue
        
        -- Округление до 2 знаков или до целого
        if maxValue <= 1 or tostring(minValue):find("%.") or tostring(maxValue):find("%.") then
             newValue = math.floor(rawValue * 100 + 0.5) / 100
        else
             newValue = math.floor(rawValue + 0.5)
        end

        sliderValue = newValue
        ValueLabel.Text = tostring(newValue)
        SliderFill.Size = UDim2.new(percent, 0, 1, 0)
        if onValueChanged then
            onValueChanged(newValue)
        end
    end

    local initialPercent = (defaultValue - minValue) / (maxValue - minValue)
    SliderFill.Size = UDim2.new(initialPercent, 0, 1, 0)

    table.insert(connections, userInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            updateSlider(input)
        end
    end))

    table.insert(connections, userInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end))

    local TrackButton = Instance.new("TextButton", SliderTrack)
    TrackButton.BackgroundTransparency = 1
    TrackButton.Size = UDim2.new(1, 0, 1, 0)
    TrackButton.Text = ""
    TrackButton.ZIndex = 1
    table.insert(connections, TrackButton.InputBegan:Connect(function(input)
         if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            updateSlider(input)
        end
    end))

    table.insert(connections, SliderFrame.MouseEnter:Connect(function()
        tweenService:Create(SliderFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {BackgroundColor3 = Color3.fromRGB(32, 32, 32)}):Play()
    end))

    table.insert(connections, SliderFrame.MouseLeave:Connect(function()
        tweenService:Create(SliderFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {BackgroundColor3 = Color3.fromRGB(28, 28, 28)}):Play()
    end))

    return SliderFrame, sliderValue
end

local function internalCreateDropdown(parent, yPos, label, options, defaultOption, onSelected)
    local selected = defaultOption
    local DropdownFrame = Instance.new("Frame")
    DropdownFrame.Parent = parent
    DropdownFrame.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
    DropdownFrame.BorderSizePixel = 0
    DropdownFrame.Position = UDim2.new(0, 15, 0, yPos)
    DropdownFrame.Size = UDim2.new(1, -30, 0, 30)
    DropdownFrame:SetAttribute("HasBackground", true)

    local DropdownCorner = Instance.new("UICorner")
    DropdownCorner.CornerRadius = UDim.new(0, 4)
    DropdownCorner.Parent = DropdownFrame

    local Label = Instance.new("TextLabel")
    Label.Parent = DropdownFrame
    Label.BackgroundTransparency = 1
    Label.Position = UDim2.new(0, 12, 0, 0)
    Label.Size = UDim2.new(0, 150, 1, 0)
    Label.Font = Enum.Font.Gotham
    Label.Text = label
    Label.TextColor3 = Color3.fromRGB(200, 200, 200)
    Label.TextSize = 13
    Label.TextXAlignment = Enum.TextXAlignment.Left

    local SelectedLabel = Instance.new("TextLabel")
    SelectedLabel.Parent = DropdownFrame
    SelectedLabel.BackgroundTransparency = 1
    SelectedLabel.Position = UDim2.new(1, -100, 0, 0)
    SelectedLabel.Size = UDim2.new(0, 80, 1, 0)
    SelectedLabel.Font = Enum.Font.GothamBold
    SelectedLabel.Text = selected
    SelectedLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    SelectedLabel.TextSize = 13
    SelectedLabel.TextXAlignment = Enum.TextXAlignment.Right

    local DropButton = Instance.new("TextButton")
    DropButton.Parent = DropdownFrame
    DropButton.BackgroundTransparency = 1
    DropButton.Size = UDim2.new(1, 0, 1, 0)
    DropButton.Text = ""

    local expanded = false
    local OptionsFrame = Instance.new("Frame")
    OptionsFrame.Parent = DropdownFrame
    OptionsFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    OptionsFrame.BorderSizePixel = 0
    OptionsFrame.Position = UDim2.new(0, 0, 1, 5)
    OptionsFrame.Size = UDim2.new(1, 0, 0, 0)
    OptionsFrame.Visible = false
    OptionsFrame.ClipsDescendants = true
    OptionsFrame:SetAttribute("HasBackground", true)

    local OptionsCorner = Instance.new("UICorner")
    OptionsCorner.CornerRadius = UDim.new(0, 4)
    OptionsCorner.Parent = OptionsFrame

    for i, option in ipairs(options) do
        local OptionButton = Instance.new("TextButton")
        OptionButton.Parent = OptionsFrame
        OptionButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
        OptionButton.BorderSizePixel = 0
        OptionButton.Position = UDim2.new(0, 0, 0, (i - 1) * 30)
        OptionButton.Size = UDim2.new(1, 0, 0, 30)
        OptionButton.Font = Enum.Font.Gotham
        OptionButton.Text = option
        OptionButton.TextColor3 = Color3.fromRGB(200, 200, 200)
        OptionButton.TextSize = 13
        OptionButton.TextXAlignment = Enum.TextXAlignment.Left
        OptionButton:SetAttribute("HasBackground", true)

        local OptionText = Instance.new("TextLabel")
        OptionText.Parent = OptionButton
        OptionText.BackgroundTransparency = 1
        OptionText.Position = UDim2.new(0, 12, 0, 0)
        OptionText.Size = UDim2.new(1, -24, 1, 0)
        OptionText.Font = Enum.Font.Gotham
        OptionText.Text = option
        OptionText.TextColor3 = Color3.fromRGB(200, 200, 200)
        OptionText.TextSize = 13
        OptionText.TextXAlignment = Enum.TextXAlignment.Left

        table.insert(connections, OptionButton.MouseButton1Click:Connect(function()
            selected = option
            SelectedLabel.Text = option
            if onSelected then
                onSelected(option)
            end
            tweenService:Create(OptionsFrame, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, 0)}):Play()
            task.wait(0.2)
            OptionsFrame.Visible = false
            expanded = false
        end))

        table.insert(connections, OptionButton.MouseEnter:Connect(function()
            tweenService:Create(OptionButton, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(30, 30, 30)}):Play()
        end))

        table.insert(connections, OptionButton.MouseLeave:Connect(function()
            tweenService:Create(OptionButton, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(25, 25, 25)}):Play()
        end))
    end

    table.insert(connections, DropButton.MouseButton1Click:Connect(function()
        expanded = not expanded
        if expanded then
            OptionsFrame.Visible = true
            tweenService:Create(OptionsFrame, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, 30 * #options)}):Play()
        else
            tweenService:Create(OptionsFrame, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, 0)}):Play()
            task.wait(0.2)
            OptionsFrame.Visible = false
        end
    end))

    table.insert(connections, DropdownFrame.MouseEnter:Connect(function()
        tweenService:Create(DropdownFrame, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(32, 32, 32)}):Play()
    end))

    table.insert(connections, DropdownFrame.MouseLeave:Connect(function()
        tweenService:Create(DropdownFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {BackgroundColor3 = Color3.fromRGB(28, 28, 28)}):Play()
    end))

    return DropdownFrame, selected
end

local function internalCreateKeybind(parent, yPos, label, defaultKey, onBind)
    local currentKey = defaultKey
    local KeybindFrame = Instance.new("Frame")
    KeybindFrame.Parent = parent
    KeybindFrame.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
    KeybindFrame.BorderSizePixel = 0
    KeybindFrame.Position = UDim2.new(0, 15, 0, yPos)
    KeybindFrame.Size = UDim2.new(1, -30, 0, 30)
    KeybindFrame:SetAttribute("HasBackground", true)

    local Label = Instance.new("TextLabel")
    Label.Parent = KeybindFrame
    Label.BackgroundTransparency = 1
    Label.Position = UDim2.new(0, 12, 0, 0)
    Label.Size = UDim2.new(0, 150, 1, 0)
    Label.Font = Enum.Font.Gotham
    Label.Text = label
    Label.TextColor3 = Color3.fromRGB(200, 200, 200)
    Label.TextSize = 13
    Label.TextXAlignment = Enum.TextXAlignment.Left

    local KeyLabel = Instance.new("TextLabel")
    KeyLabel.Parent = KeybindFrame
    KeyLabel.BackgroundTransparency = 1
    KeyLabel.Position = UDim2.new(1, -100, 0, 0)
    KeyLabel.Size = UDim2.new(0, 80, 1, 0)
    KeyLabel.Font = Enum.Font.GothamBold
    KeyLabel.Text = currentKey.Name
    KeyLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    KeyLabel.TextSize = 13
    KeyLabel.TextXAlignment = Enum.TextXAlignment.Right

    local KeyButton = Instance.new("TextButton")
    KeyButton.Parent = KeybindFrame
    KeyButton.BackgroundTransparency = 1
    KeyButton.Size = UDim2.new(1, 0, 1, 0)
    KeyButton.Text = ""
    local binding = false 

    table.insert(connections, KeyButton.MouseButton1Click:Connect(function()
        binding = true
        KeyLabel.Text = "..."
    end))

    table.insert(connections, userInputService.InputBegan:Connect(function(input)
        if binding and input.KeyCode ~= Enum.KeyCode.Unknown then
            binding = false
            currentKey = input.KeyCode
            KeyLabel.Text = currentKey.Name
            if onBind then
                onBind(currentKey)
            end
        end
    end))

    table.insert(connections, KeybindFrame.MouseEnter:Connect(function() 
        tweenService:Create(KeybindFrame, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(32, 32, 32)}):Play()
    end))
    
    table.insert(connections, KeybindFrame.MouseLeave:Connect(function()
        tweenService:Create(KeybindFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {BackgroundColor3 = Color3.fromRGB(28, 28, 28)}):Play()
    end))

    return KeybindFrame, currentKey
end

local function internalCreateColorPicker(parent, yPos, label, defaultColor, onColorChanged)
    local currentColor = defaultColor
    local expanded = false
    local ColorPickerFrame = Instance.new("Frame")
    ColorPickerFrame.Parent = parent
    ColorPickerFrame.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
    ColorPickerFrame.BorderSizePixel = 0
    ColorPickerFrame.Position = UDim2.new(0, 15, 0, yPos)
    ColorPickerFrame.Size = UDim2.new(1, -30, 0, 30)
    ColorPickerFrame:SetAttribute("HasBackground", true)

    local ColorButton = Instance.new("TextButton")
    ColorButton.Parent = ColorPickerFrame
    ColorButton.BackgroundTransparency = 1
    ColorButton.Size = UDim2.new(1, 0, 1, 0)
    ColorButton.Text = ""

    local Label = Instance.new("TextLabel")
    Label.Parent = ColorPickerFrame
    Label.BackgroundTransparency = 1
    Label.Position = UDim2.new(0, 12, 0, 0)
    Label.Size = UDim2.new(0, 150, 1, 0)
    Label.Font = Enum.Font.Gotham
    Label.Text = label
    Label.TextColor3 = Color3.fromRGB(200, 200, 200)
    Label.TextSize = 13
    Label.TextXAlignment = Enum.TextXAlignment.Left

    local ColorDisplay = Instance.new("Frame")
    ColorDisplay.Parent = ColorPickerFrame
    ColorDisplay.BackgroundColor3 = defaultColor
    ColorDisplay.BorderSizePixel = 0
    ColorDisplay.Position = UDim2.new(1, -38, 0.5, -10)
    ColorDisplay.Size = UDim2.new(0, 20, 0, 20)
    ColorDisplay:SetAttribute("HasBackground", true)

    local PickerFrame = Instance.new("Frame")
    PickerFrame.Parent = ColorPickerFrame
    PickerFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    PickerFrame.BorderSizePixel = 0
    PickerFrame.Position = UDim2.new(0, 0, 1, 5)
    PickerFrame.Size = UDim2.new(1, 0, 0, 0)
    PickerFrame.Visible = false
    PickerFrame.ClipsDescendants = true
    PickerFrame:SetAttribute("HasBackground", true)

    local function updateColor()
        ColorDisplay.BackgroundColor3 = currentColor
        if onColorChanged then
            onColorChanged(currentColor)
        end
    end
    
    local rSlider, rValue
    rSlider, rValue = internalCreateSlider(PickerFrame, 0, "R", currentColor.R * 255, 0, 255, false, function(value)
        currentColor = Color3.fromRGB(value, currentColor.G * 255, currentColor.B * 255)
        updateColor()
    end)
    local gSlider, gValue
    gSlider, gValue = internalCreateSlider(PickerFrame, 40, "G", currentColor.G * 255, 0, 255, false, function(value)
        currentColor = Color3.fromRGB(currentColor.R * 255, value, currentColor.B * 255)
        updateColor()
    end)
    local bSlider, bValue
    bSlider, bValue = internalCreateSlider(PickerFrame, 80, "B", currentColor.B * 255, 0, 255, false, function(value)
        currentColor = Color3.fromRGB(currentColor.R * 255, currentColor.G * 255, value)
        updateColor()
    end)

    table.insert(connections, ColorButton.MouseButton1Click:Connect(function()
        expanded = not expanded
        if expanded then
            PickerFrame.Visible = true
            tweenService:Create(PickerFrame, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, 120)}):Play()
        else
            tweenService:Create(PickerFrame, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, 0)}):Play()
            task.wait(0.2)
            PickerFrame.Visible = false
        end
    end))

    table.insert(connections, ColorPickerFrame.MouseEnter:Connect(function() 
        tweenService:Create(ColorPickerFrame, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(32, 32, 32)}):Play()
    end))
    table.insert(connections, ColorPickerFrame.MouseLeave:Connect(function()
        tweenService:Create(ColorPickerFrame, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(28, 28, 28)}):Play()
    end))

    return ColorPickerFrame
end

local function switchTab(tabName)
    if CurrentTabName == tabName then return end
    
    local tabFrame = CrimLib.Tabs[tabName]
    if tabFrame then
        -- Скрыть все вкладки
        for _, tab in pairs(CrimLib.Tabs) do
            tab.Visible = false
        end
        
        -- Показать выбранную вкладку
        tabFrame.Visible = true
        CurrentTabName = tabName
        
        -- Обновить заголовок
        local titleText = ""
        if tabName:find("Combat") then
            titleText = "Combat"
        elseif tabName:find("Enemy") then
            titleText = "Enemy"
        elseif tabName:find("Settings") then
            titleText = "Settings"
        end
        Title.Text = "CrimBot | " .. titleText
    end
end

-- [[ ПУБЛИЧНЫЙ API ]]

-- :Initialize
function CrimLib:Initialize(titleName, UnloadKey, MenuKey)
    ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "CrimLibUI"
    ScreenGui.Parent = CoreGui or game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.ResetOnSpawn = false

    MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Parent = ScreenGui
    MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    MainFrame.BorderSizePixel = 0
    MainFrame.Position = UDim2.new(0.5, -300, 0.5, -287.5)
    MainFrame.Size = UDim2.new(0, 600, 0, 575)
    MainFrame.Visible = false
    MainFrame.Active = true
    
    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, 8)
    MainCorner.Parent = MainFrame
    
    Title = Instance.new("TextLabel")
    Title.Name = "Title"
    Title.Parent = MainFrame
    Title.BackgroundTransparency = 1
    Title.Position = UDim2.new(0, 80, 0, 0)
    Title.Size = UDim2.new(1, -80, 0, 60)
    Title.Font = Enum.Font.GothamBold
    Title.Text = (titleName or "CrimLib") .. " | Combat"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.TextSize = 20
    Title.TextXAlignment = Enum.TextXAlignment.Left

    SidebarFrame = Instance.new("Frame")
    SidebarFrame.Name = "Sidebar"
    SidebarFrame.Parent = MainFrame
    SidebarFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    SidebarFrame.BorderSizePixel = 0
    SidebarFrame.Size = UDim2.new(0, 70, 1, 0)
    
    ContentFrame = Instance.new("Frame")
    ContentFrame.Name = "ContentFrame"
    ContentFrame.Parent = MainFrame
    ContentFrame.BackgroundTransparency = 1
    ContentFrame.Position = UDim2.new(0, 70, 0, 60)
    ContentFrame.Size = UDim2.new(1, -70, 1, -60)
    
    local Scroll = Instance.new("ScrollingFrame")
    Scroll.Parent = ContentFrame
    Scroll.BackgroundTransparency = 1
    Scroll.Size = UDim2.new(1, 0, 1, 0)
    Scroll.CanvasSize = UDim2.new(0, 0, 0, 600)
    Scroll.ScrollBarThickness = 6
    ContentFrame = Scroll -- Сделать Scrollable

    -- Логика перетаскивания (Header)
    local HeaderFrame = Instance.new("Frame")
    HeaderFrame.Parent = MainFrame
    HeaderFrame.BackgroundTransparency = 1
    HeaderFrame.Size = UDim2.new(1, 0, 0, 60)
    HeaderFrame.Active = true
    HeaderFrame.ZIndex = 10
    
    local dragging = false
    local dragStart = Vector2.new()
    local startPos = UDim2.new()
    
    local function dragStartFunc(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
        end
    end
    
    local function dragEndFunc(input)
        dragging = false
    end

    local function dragUpdate(input)
         local delta = input.Position - dragStart
         MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    table.insert(connections, HeaderFrame.InputBegan:Connect(dragStartFunc))
    table.insert(connections, userInputService.InputEnded:Connect(dragEndFunc))
    table.insert(connections, userInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            dragUpdate(input)
        end
    end))
    

    -- Логика биндов INSERT и DELETE
    local menuVisible = false
    local unloadKey = UnloadKey or Enum.KeyCode.Delete
    local menuKey = MenuKey or Enum.KeyCode.Insert
    
    table.insert(connections, userInputService.InputBegan:Connect(function(input)
        if input.KeyCode == menuKey then
            menuVisible = not menuVisible
            MainFrame.Visible = menuVisible
        elseif input.KeyCode == unloadKey then
            -- Вызов функции очистки
            for _, callback in ipairs(UnloadCallbacks) do callback() end
            for _, connection in ipairs(connections) do connection:Disconnect() end
            connections = {}
            if ScreenGui then ScreenGui:Destroy() end
        end
    end))
end

-- Вспомогательная функция для создания кнопки вкладки
local function createTabButton(tabName, buttonText, yOffset)
    local Button = Instance.new("TextButton")
    Button.Parent = SidebarFrame
    Button.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    Button.Size = UDim2.new(1, 0, 0, 40)
    Button.Position = UDim2.new(0, 0, 0, yOffset)
    Button.Text = buttonText
    Button.Font = Enum.Font.Gotham
    Button.TextColor3 = Color3.fromRGB(150, 150, 150)
    Button.TextSize = 14
    Button.TextWrapped = true

    table.insert(connections, Button.MouseButton1Click:Connect(function()
        switchTab(tabName)
    end))
end

-- :CreateTab
function CrimLib:CreateTab(name, column)
    local buttonYOffset = (#CrimLib.Tabs) * 40
    local contentColParent = Instance.new("Frame")
    contentColParent.Name = "Tab_" .. name
    contentColParent.Parent = ContentFrame
    contentColParent.BackgroundTransparency = 1
    contentColParent.Size = UDim2.new(0.5, 0, 1, 0)
    contentColParent.Position = (column == "Right" and UDim2.new(0.5, 0, 0, 0)) or UDim2.new(0, 0, 0, 0)
    contentColParent.Visible = name == "CombatLeft" -- Показываем CombatLeft по умолчанию

    -- Создание кнопки на боковой панели
    local buttonText = ""
    if name == "CombatLeft" or name == "CombatRight" then
        buttonText = "Combat"
    elseif name == "EnemyLeft" or name == "EnemyRight" then
        buttonText = "Enemy"
    end
    
    if not CrimLib.Tabs[name] and name:sub(-4) == "Left" then
        createTabButton(name, buttonText, buttonYOffset)
    end

    CrimLib.Tabs[name] = contentColParent
    return contentColParent
end

-- :AddToggle
function CrimLib:AddToggle(tabName, settings)
    local parent = CrimLib.Tabs[tabName]
    if not parent then warn("CrimLib: Invalid tabName for AddToggle: " .. tabName) return end

    local yPos = CrimLib.yOffsets[tabName]
    local frame, value = internalCreateToggle(parent, yPos, settings.Name, settings.DefaultValue, settings.Callback)
    CrimLib.yOffsets[tabName] = yPos + 40
    return frame, value
end

-- :AddSlider
function CrimLib:AddSlider(tabName, settings)
    local parent = CrimLib.Tabs[tabName]
    if not parent then warn("CrimLib: Invalid tabName for AddSlider: " .. tabName) return end

    local yPos = CrimLib.yOffsets[tabName]
    local frame, value = internalCreateSlider(parent, yPos, settings.Name, settings.DefaultValue, settings.Min, settings.Max, settings.Override or false, settings.Callback)
    CrimLib.yOffsets[tabName] = yPos + 40
    return frame, value
end

-- :AddDropdown
function CrimLib:AddDropdown(tabName, settings)
    local parent = CrimLib.Tabs[tabName]
    if not parent then warn("CrimLib: Invalid tabName for AddDropdown: " .. tabName) return end

    local yPos = CrimLib.yOffsets[tabName]
    local frame, value = internalCreateDropdown(parent, yPos, settings.Name, settings.Options, settings.DefaultValue, settings.Callback)
    CrimLib.yOffsets[tabName] = yPos + 40
    return frame, value
end

-- :AddKeybind
function CrimLib:AddKeybind(tabName, settings)
    local parent = CrimLib.Tabs[tabName]
    if not parent then warn("CrimLib: Invalid tabName for AddKeybind: " .. tabName) return end

    local yPos = CrimLib.yOffsets[tabName]
    local frame, value = internalCreateKeybind(parent, yPos, settings.Name, settings.DefaultValue, settings.Callback)
    CrimLib.yOffsets[tabName] = yPos + 40
    return frame, value
end

-- :AddColorPicker
function CrimLib:AddColorPicker(tabName, settings)
    local parent = CrimLib.Tabs[tabName]
    if not parent then warn("CrimLib: Invalid tabName for AddColorPicker: " .. tabName) return end

    local yPos = CrimLib.yOffsets[tabName]
    local frame = internalCreateColorPicker(parent, yPos, settings.Name, settings.DefaultValue, settings.Callback)
    CrimLib.yOffsets[tabName] = yPos + 120 -- Увеличиваем отступ
    return frame
end

-- :AddUnloadCallback
function CrimLib:AddUnloadCallback(callback)
    table.insert(UnloadCallbacks, callback)
end

return CrimLib
