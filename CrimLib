-- CrimLib.lua (Библиотека CrimLib: Интерфейс и Состояние)
local CrimLib = {}
local connections = {}
local tweenService = game:GetService("TweenService")
local userInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local ScreenGui
local MainFrame
local TabContainer
local Sidebar

-- Хранилище для текущих значений всех элементов управления
CrimLib.Values = {}
-- Хранилище ссылок на фреймы содержимого вкладок
CrimLib.TabContents = {}
-- Хранилище ссылок на фреймы секций
CrimLib.Sections = {}
-- Динамические смещения Y для каждого раздела
CrimLib.yOffsets = {}

-- Данные о вкладках для отрисовки (Ragebot активен по умолчанию)
local sidebarIcons = {
    {y = 15, name = "Legitbot", active = false},
    {y = 85, name = "Ragebot", active = true},
    {y = 155, name = "Enemy", active = false},
    {y = 225, name = "World", active = false},
    {y = 295, name = "SkinChanger", active = false},
    {y = 365, name = "Misc", active = false},
    {y = 435, name = "Config", active = false}
}

local function getUniqueKey(sectionName, elementName)
    return sectionName .. "_" .. elementName
end

-- ====================================================================
-- АБСТРАКТНЫЕ ФУНКЦИИ ОТРИСОВКИ ЭЛЕМЕНТОВ
-- ====================================================================

local function internalCreateToggle(parent, yPos, label, enabled, callback)
    local key = getUniqueKey(parent.Name, label)
    CrimLib.Values[key] = enabled
    local toggleState = enabled
    
    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Parent = parent
    ToggleFrame.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
    ToggleFrame.Position = UDim2.new(0, 15, 0, yPos)
    ToggleFrame.Size = UDim2.new(1, -30, 0, 30)
    
    local Label = Instance.new("TextLabel")
    Label.Text = label
    Label.TextColor3 = toggleState and Color3.fromRGB(255, 200, 50) or Color3.fromRGB(200, 200, 200)
    Label.Parent = ToggleFrame
    Label.Position = UDim2.new(0, 12, 0, 0)
    Label.Size = UDim2.new(0, 150, 1, 0)

    local Checkbox = Instance.new("Frame")
    Checkbox.BackgroundColor3 = toggleState and Color3.fromRGB(60, 160, 255) or Color3.fromRGB(60, 60, 60)
    Checkbox.Parent = ToggleFrame
    Checkbox.Position = UDim2.new(1, -40, 0.5, -10)
    Checkbox.Size = UDim2.new(0, 20, 0, 20)
    Instance.new("UICorner", Checkbox).CornerRadius = UDim.new(0, 4)

    local ClickButton = Instance.new("TextButton")
    ClickButton.Parent = ToggleFrame
    ClickButton.BackgroundTransparency = 1
    ClickButton.Size = UDim2.new(1, 0, 1, 0)
    
    ClickButton.MouseButton1Click:Connect(function()
        toggleState = not toggleState
        CrimLib.Values[key] = toggleState
        
        -- Используем TweenService для плавного изменения цвета
        tweenService:Create(Checkbox, TweenInfo.new(0.15), {
            BackgroundColor3 = toggleState and Color3.fromRGB(60, 160, 255) or Color3.fromRGB(60, 60, 60)
        }):Play()
        tweenService:Create(Label, TweenInfo.new(0.15), {
            TextColor3 = toggleState and Color3.fromRGB(255, 200, 50) or Color3.fromRGB(200, 200, 200)
        }):Play()
        
        if callback then
            callback(toggleState) -- Вызов обратного вызова
        end
    end)
    
    return ToggleFrame
end

local function internalCreateSlider(parent, yPos, label, defaultValue, minValue, maxValue, callback)
    local key = getUniqueKey(parent.Name, label)
    CrimLib.Values[key] = defaultValue
    local sliderValue = defaultValue
    
    local SliderFrame = Instance.new("Frame")
    SliderFrame.Parent = parent
    SliderFrame.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
    SliderFrame.Position = UDim2.new(0, 15, 0, yPos)
    SliderFrame.Size = UDim2.new(1, -30, 0, 40)
    
    local Label = Instance.new("TextLabel", SliderFrame)
    Label.Text = label
    Label.TextColor3 = Color3.fromRGB(200, 200, 200)
    Label.BackgroundTransparency = 1
    Label.Position = UDim2.new(0, 12, 0, 5)
    Label.Size = UDim2.new(0, 150, 0, 15)

    local ValueLabel = Instance.new("TextLabel", SliderFrame)
    ValueLabel.Text = tostring(defaultValue)
    ValueLabel.TextColor3 = Color3.fromRGB(255, 200, 50)
    ValueLabel.BackgroundTransparency = 1
    ValueLabel.TextXAlignment = Enum.TextXAlignment.Right
    ValueLabel.Position = UDim2.new(1, -60, 0, 5)
    ValueLabel.Size = UDim2.new(0, 48, 0, 15)

    local SliderTrack = Instance.new("Frame", SliderFrame)
    SliderTrack.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    SliderTrack.Position = UDim2.new(0, 12, 0, 28)
    SliderTrack.Size = UDim2.new(1, -24, 0, 4)
    Instance.new("UICorner", SliderTrack).CornerRadius = UDim.new(1, 0)

    local SliderFill = Instance.new("Frame", SliderTrack)
    SliderFill.BackgroundColor3 = Color3.fromRGB(60, 160, 255)
    SliderFill.Size = UDim2.new((defaultValue-minValue)/(maxValue-minValue), 0, 1, 0)
    Instance.new("UICorner", SliderFill).CornerRadius = UDim.new(1, 0)

    local function updateSlider(input)
        local trackPos = SliderTrack.AbsolutePosition.X
        local trackSize = SliderTrack.AbsoluteSize.X
        local mousePos = input.Position.X
        
        local delta = math.clamp((mousePos - trackPos) / trackSize, 0, 1)
        
        local rawValue = minValue + (maxValue - minValue) * delta
        local newValue = math.floor(rawValue + 0.5) -- Округление до целого
        
        sliderValue = newValue
        CrimLib.Values[key] = newValue
        ValueLabel.Text = tostring(newValue)
        SliderFill.Size = UDim2.new(delta, 0, 1, 0)
        
        if callback then
            callback(newValue)
        end
    end
    
    local dragging = false
    local ClickDetector = Instance.new("TextButton")
    ClickDetector.Parent = SliderFrame
    ClickDetector.BackgroundTransparency = 1
    ClickDetector.Position = UDim2.new(0, 0, 0, 20)
    ClickDetector.Size = UDim2.new(1, 0, 0, 20)

    ClickDetector.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            updateSlider(input)
        end
    end)
    
    -- Глобальные соединения для перетаскивания
    table.insert(connections, userInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            updateSlider(input)
        end
    end))
    table.insert(connections, userInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end))

    return SliderFrame
end

local function internalCreateDropdown(parent, yPos, label, defaultValue, options, callback)
    local key = getUniqueKey(parent.Name, label)
    CrimLib.Values[key] = defaultValue
    local selectedValue = defaultValue
    local expanded = false

    local DropdownFrame = Instance.new("Frame")
    DropdownFrame.Parent = parent
    DropdownFrame.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
    DropdownFrame.Position = UDim2.new(0, 15, 0, yPos)
    DropdownFrame.Size = UDim2.new(1, -30, 0, 30)
    
    local Label = Instance.new("TextLabel")
    Label.Text = label .. ": "
    Label.Parent = DropdownFrame
    Label.BackgroundTransparency = 1
    Label.TextColor3 = Color3.fromRGB(200, 200, 200)
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.Position = UDim2.new(0, 12, 0, 0)
    Label.Size = UDim2.new(0, 150, 1, 0)

    local ValueLabel = Instance.new("TextLabel")
    ValueLabel.Text = selectedValue
    ValueLabel.Parent = DropdownFrame
    ValueLabel.BackgroundTransparency = 1
    ValueLabel.TextColor3 = Color3.fromRGB(255, 200, 50)
    ValueLabel.Position = UDim2.new(0, 150, 0, 0)
    ValueLabel.Size = UDim2.new(1, -170, 1, 0)
    ValueLabel.TextXAlignment = Enum.TextXAlignment.Left

    local ClickButton = Instance.new("TextButton")
    ClickButton.Parent = DropdownFrame
    ClickButton.BackgroundTransparency = 1
    ClickButton.Size = UDim2.new(1, 0, 1, 0)

    local OptionsFrame = Instance.new("Frame")
    OptionsFrame.Parent = DropdownFrame
    OptionsFrame.ZIndex = 2
    OptionsFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    OptionsFrame.Position = UDim2.new(0, 0, 1, 0)
    OptionsFrame.Size = UDim2.new(1, 0, 0, 0)
    OptionsFrame.ClipsDescendants = true
    
    local function expandOptions(state)
        expanded = state
        local targetSizeY = state and #options * 30 or 0
        local targetSize = UDim2.new(1, 0, 0, targetSizeY)
        tweenService:Create(OptionsFrame, TweenInfo.new(0.15), {Size = targetSize}):Play()
    end
    
    for i, optionText in ipairs(options) do
        local OptionBtn = Instance.new("TextButton")
        OptionBtn.Parent = OptionsFrame
        OptionBtn.Text = optionText
        OptionBtn.Position = UDim2.new(0, 0, 0, (i - 1) * 30)
        OptionBtn.Size = UDim2.new(1, 0, 0, 30)
        OptionBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
        OptionBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
        OptionBtn.TextXAlignment = Enum.TextXAlignment.Left
        OptionBtn.Text = "  " .. optionText
        
        OptionBtn.MouseButton1Click:Connect(function()
            selectedValue = optionText
            CrimLib.Values[key] = selectedValue
            ValueLabel.Text = selectedValue
            expandOptions(false)
            if callback then
                callback(selectedValue)
            end
        end)
    end

    ClickButton.MouseButton1Click:Connect(function()
        expandOptions(not expanded)
    end)
    
    return DropdownFrame
end

local function internalCreateColorPicker(parent, yPos, label, defaultColor, callback)
    local key = getUniqueKey(parent.Name, label)
    CrimLib.Values[key] = defaultColor
    local currentColor = defaultColor

    local PickerFrame = Instance.new("Frame")
    PickerFrame.Parent = parent
    PickerFrame.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
    PickerFrame.Position = UDim2.new(0, 15, 0, yPos)
    PickerFrame.Size = UDim2.new(1, -30, 0, 30)

    local Label = Instance.new("TextLabel", PickerFrame)
    Label.Text = label
    Label.BackgroundTransparency = 1
    Label.TextColor3 = Color3.fromRGB(200, 200, 200)
    Label.Position = UDim2.new(0, 12, 0, 0)
    Label.Size = UDim2.new(0, 150, 1, 0)

    local ColorPreview = Instance.new("Frame", PickerFrame)
    ColorPreview.BackgroundColor3 = defaultColor
    ColorPreview.Position = UDim2.new(1, -40, 0.5, -10)
    ColorPreview.Size = UDim2.new(0, 20, 0, 20)
    Instance.new("UICorner", ColorPreview).CornerRadius = UDim.new(0, 4)
    
    -- Имитация открытия ColorPicker (просто меняет цвет по клику для теста)
    local ClickButton = Instance.new("TextButton", PickerFrame)
    ClickButton.BackgroundTransparency = 1
    ClickButton.Size = UDim2.new(1, 0, 1, 0)

    local currentHue = Color3.toHSV(defaultColor)
    ClickButton.MouseButton1Click:Connect(function()
        currentHue = (currentHue + 0.1) % 1
        currentColor = Color3.fromHSV(currentHue, 1, 1) -- Смена цвета по HSV
        
        CrimLib.Values[key] = currentColor
        ColorPreview.BackgroundColor3 = currentColor
        
        if callback then
            callback(currentColor)
        end
    end)
    
    return PickerFrame
end

-- ====================================================================
-- ПУБЛИЧНЫЙ ИНТЕРФЕЙС ИНИЦИАЛИЗАЦИИ
-- ====================================================================

function CrimLib:Initialize(TitleName, MenuKey, UnloadKey)
    ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "CrimLibGui"
    ScreenGui.Parent = CoreGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.ResetOnSpawn = false
    
    MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Parent = ScreenGui
    MainFrame.Size = UDim2.new(0, 843, 0, 575)
    MainFrame.Position = UDim2.new(0.5, -421.5, 0.5, -287.5)
    MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    MainFrame.Visible = false
    MainFrame.Active = true
    Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)
    
    -- Header (с логикой перетаскивания)
    local Header = Instance.new("Frame", MainFrame)
    Header.Name = "Header"
    Header.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
    Header.Size = UDim2.new(1, 0, 0, 60)
    local Title = Instance.new("TextLabel", Header)
    Title.Text = TitleName
    Title.BackgroundTransparency = 1
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.Position = UDim2.new(0, 80, 0, 0)
    Title.Size = UDim2.new(1, -80, 1, 0)

    -- Sidebar
    Sidebar = Instance.new("Frame", MainFrame)
    Sidebar.Name = "Sidebar"
    Sidebar.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
    Sidebar.Position = UDim2.new(0, 0, 0, 60)
    Sidebar.Size = UDim2.new(0, 70, 0, 515)
    
    -- Content Frame
    local ContentFrame = Instance.new("Frame", MainFrame)
    ContentFrame.BackgroundTransparency = 1
    ContentFrame.Position = UDim2.new(0, 70, 0, 60)
    ContentFrame.Size = UDim2.new(1, -70, 1, -60)
    
    TabContainer = Instance.new("Frame", ContentFrame)
    TabContainer.Name = "TabContainer"
    TabContainer.BackgroundTransparency = 1
    TabContainer.Size = UDim2.new(1, 0, 1, 0)
    
    -- Логика перетаскивания (Header)
    local dragging = false
    local dragStart
    local startPos
    
    Header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
        end
    end)

    table.insert(connections, userInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end))
    table.insert(connections, userInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end))
    
    -- Логика переключения меню
    local menuToggleConn = userInputService.InputBegan:Connect(function(input)
        if input.KeyCode == MenuKey then
            MainFrame.Visible = not MainFrame.Visible
        end
    end)
    table.insert(connections, menuToggleConn)

    return MainFrame, ScreenGui, connections
end

function CrimLib:AddTab(Name)
    local tabData = nil
    for _, data in ipairs(sidebarIcons) do
        if data.name == Name then tabData = data break end
    end
    if not tabData then return end
    
    local IconFrame = Instance.new("Frame", Sidebar)
    IconFrame.Name = "Tab_" .. Name
    IconFrame.BackgroundColor3 = tabData.active and Color3.fromRGB(25, 25, 25) or Color3.fromRGB(18, 18, 18)
    IconFrame.Position = UDim2.new(0, 0, 0, tabData.y)
    IconFrame.Size = UDim2.new(1, 0, 0, 60)
    
    local ContentFrame = Instance.new("ScrollingFrame", TabContainer)
    ContentFrame.Name = Name .. "TabContent"
    ContentFrame.BackgroundTransparency = 1
    ContentFrame.Size = UDim2.new(1, 0, 1, 0)
    ContentFrame.Visible = tabData.active
    ContentFrame.ScrollBarThickness = 6
    ContentFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    
    local TabButton = Instance.new("TextButton", IconFrame)
    TabButton.BackgroundTransparency = 1
    TabButton.Size = UDim2.new(1, 0, 1, 0)

    TabButton.MouseButton1Click:Connect(function()
        for _, content in pairs(CrimLib.TabContents) do
            content.Visible = false
        end
        ContentFrame.Visible = true
    end)

    CrimLib.TabContents[Name] = ContentFrame
end

function CrimLib:AddSection(tabName, sectionName, position)
    local parent = CrimLib.TabContents[tabName]
    if not parent then warn("CrimLib: Invalid tabName for AddSection: " .. tabName) return end

    local SectionFrame = Instance.new("Frame", parent)
    SectionFrame.Name = sectionName .. "Section"
    SectionFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    SectionFrame.Position = UDim2.new(0, position.x, 0, position.y)
    SectionFrame.Size = UDim2.new(0, position.width, 0, position.height)
    Instance.new("UICorner", SectionFrame).CornerRadius = UDim.new(0, 4)
    
    local SectionTitle = Instance.new("TextLabel", SectionFrame)
    SectionTitle.Text = string.upper(sectionName)
    SectionTitle.BackgroundTransparency = 1
    SectionTitle.TextColor3 = Color3.fromRGB(180, 180, 180)
    SectionTitle.TextXAlignment = Enum.TextXAlignment.Left
    SectionTitle.Position = UDim2.new(0, 15, 0, 10)
    SectionTitle.Size = UDim2.new(1, -30, 0, 25)

    CrimLib.Sections[sectionName] = SectionFrame
    CrimLib.yOffsets[sectionName] = 40
    
    return SectionFrame
end

function CrimLib:AddToggle(sectionName, settings)
    local parent = CrimLib.Sections[sectionName]
    if not parent then warn("CrimLib: Invalid sectionName for AddToggle: " .. sectionName) return end

    local yPos = CrimLib.yOffsets[sectionName]
    internalCreateToggle(parent, yPos, settings.Name, settings.DefaultValue, settings.Callback)
    CrimLib.yOffsets[sectionName] = yPos + 35
end

function CrimLib:AddSlider(sectionName, settings)
    local parent = CrimLib.Sections[sectionName]
    if not parent then warn("CrimLib: Invalid sectionName for AddSlider: " .. sectionName) return end

    local yPos = CrimLib.yOffsets[sectionName]
    internalCreateSlider(parent, yPos, settings.Name, settings.DefaultValue, settings.Min, settings.Max, settings.Callback)
    CrimLib.yOffsets[sectionName] = yPos + 45
end

function CrimLib:AddDropdown(sectionName, settings)
    local parent = CrimLib.Sections[sectionName]
    if not parent then warn("CrimLib: Invalid sectionName for AddDropdown: " .. sectionName) return end

    local yPos = CrimLib.yOffsets[sectionName]
    internalCreateDropdown(parent, yPos, settings.Name, settings.DefaultValue, settings.Options, settings.Callback)
    CrimLib.yOffsets[sectionName] = yPos + 35
end

function CrimLib:AddColorPicker(sectionName, settings)
    local parent = CrimLib.Sections[sectionName]
    if not parent then warn("CrimLib: Invalid sectionName for AddColorPicker: " .. sectionName) return end

    local yPos = CrimLib.yOffsets[sectionName]
    internalCreateColorPicker(parent, yPos, settings.Name, settings.DefaultValue, settings.Callback)
    CrimLib.yOffsets[sectionName] = yPos + 35
end

return CrimLib
