-- Library.lua: CrimUI Library (Rayfield-like structure)

local Library = {}
local Components = {}

-- Services
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

-- CONSTANTS & STYLE (Extracted from Crim.lua)
local TWEEN_INFO_SHORT = TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local TWEEN_INFO_TAB = TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local TWEEN_INFO_DRAG = TweenInfo.new(0.1, Enum.EasingStyle.Linear)

local COLORS = {
    BG_MAIN = Color3.fromRGB(18, 18, 18),         -- Sidebar, TargetInfoWindow BG
    BG_WINDOW_ACTIVE = Color3.fromRGB(25, 25, 25), -- Selected Tab BG / Content Frame Parent BG
    BG_ELEMENT_OFF = Color3.fromRGB(35, 35, 35),   -- Toggle/Input/Track BG (Default)
    ACCENT_GREEN = Color3.fromRGB(70, 200, 70),   -- Toggle ON, Slider Fill (Main)
    ACCENT_BLUE = Color3.fromRGB(60, 160, 255),    -- Opacity Slider Fill
    TEXT = Color3.fromRGB(255, 255, 255),
    BORDER = Color3.fromRGB(35, 35, 35),           -- TargetInfoWindow Border
}

local SIZES = {
    SIDEBAR_W = 70,
    HEADER_H = 60,
    ELEM_H = 30,           -- Element Height (Toggle, Slider, Input)
    ELEM_W = 300,           -- Element Width
    CORNER_RADIUS = UDim.new(0, 6),
    TAB_INDICATOR_W = 4,
    COLUMN_SPACING_X = 20,
    COLUMN_SPACING_Y = 20,
    COLUMN_LEFT_X = 20,     -- Position of the first column
    COLUMN_RIGHT_X = 340,   -- Position of the second column (300 width + 20 space + 20 start = 340)
}

-- PRIVATE UTILS

local function create(className, properties, parent)
    local obj = Instance.new(className)
    for k, v in pairs(properties) do
        obj[k] = v
    end
    obj.Parent = parent
    return obj
end

-- COMPONENTS (TargetInfoWindow, Toggle, Slider, etc.)

function Components.TargetInfoWindow(parentFrame)
    local TargetInfoWindow = create("Frame", {
        Name = "TargetInfoWindow",
        BackgroundColor3 = COLORS.BG_MAIN,
        BorderSizePixel = 1,
        BorderColor3 = COLORS.BORDER,
        Position = UDim2.new(0.5, -150, 1, -80), -- Bottom center of MainFrame
        Size = UDim2.new(0, 300, 0, 70),
        Visible = false,
        ZIndex = 2 -- Above ContentFrame
    }, parentFrame)

    create("UICorner", { CornerRadius = SIZES.CORNER_RADIUS }, TargetInfoWindow)

    local TargetNameLabel = create("TextLabel", {
        Name = "TargetNameLabel",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -10, 0, 20),
        Position = UDim2.new(0, 5, 0, 5),
        Font = Enum.Font.GothamSemibold,
        Text = "Target Name",
        TextColor3 = COLORS.TEXT,
        TextSize = 16,
        TextXAlignment = Enum.TextXAlignment.Left,
    }, TargetInfoWindow)

    local TargetDistanceLabel = create("TextLabel", {
        Name = "TargetDistanceLabel",
        BackgroundTransparency = 1,
        Size = UDim2.new(0.5, 0, 0, 20),
        Position = UDim2.new(0.5, 0, 0, 5),
        Font = Enum.Font.Gotham,
        Text = "Dist: 0.0m",
        TextColor3 = COLORS.TEXT,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Right,
    }, TargetInfoWindow)

    local HealthBarContainer = create("Frame", {
        Name = "HealthBarContainer",
        BackgroundColor3 = COLORS.BG_ELEMENT_OFF,
        Position = UDim2.new(0, 5, 0, 30),
        Size = UDim2.new(1, -10, 0, 10),
    }, TargetInfoWindow)
    create("UICorner", { CornerRadius = UDim.new(0, 4) }, HealthBarContainer)

    local HealthBarFill = create("Frame", {
        Name = "HealthBarFill",
        BackgroundColor3 = COLORS.ACCENT_GREEN, -- Health color
        Size = UDim2.new(1, 0, 1, 0), -- Default to full
    }, HealthBarContainer)
    create("UICorner", { CornerRadius = UDim.new(0, 4) }, HealthBarFill)

    local HealthTextLabel = create("TextLabel", {
        Name = "HealthTextLabel",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 10),
        Position = UDim2.new(0, 0, 0, 30),
        Font = Enum.Font.GothamSemibold,
        Text = "100%",
        TextColor3 = COLORS.TEXT,
        TextSize = 12,
    }, TargetInfoWindow)
    
    return {
        Frame = TargetInfoWindow,
        TargetName = TargetNameLabel,
        TargetDistance = TargetDistanceLabel,
        HealthFill = HealthBarFill,
        HealthText = HealthTextLabel
    }
end

-- Component.Toggle
function Components.Toggle(parent, name, default, callback)
    local state = default
    local elem = create("TextButton", {
        Name = "Toggle_" .. name:gsub("%s+", ""),
        BackgroundColor3 = state and COLORS.ACCENT_GREEN or COLORS.BG_ELEMENT_OFF,
        Size = UDim2.new(0, SIZES.ELEM_W, 0, SIZES.ELEM_H),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = COLORS.TEXT,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = parent,
    })
    create("UICorner", { CornerRadius = SIZES.CORNER_RADIUS }, elem)

    local status = create("TextLabel", {
        Name = "Status",
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -60, 0, 0),
        Size = UDim2.new(0, 60, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = state and "ON" or "OFF",
        TextColor3 = COLORS.TEXT,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Right,
        Parent = elem,
    })

    local function update(newState)
        state = newState
        local newColor = state and COLORS.ACCENT_GREEN or COLORS.BG_ELEMENT_OFF
        status.Text = state and "ON" or "OFF"
        
        TweenService:Create(elem, TWEEN_INFO_SHORT, { BackgroundColor3 = newColor }):Play()
    end
    
    elem.MouseEnter:Connect(function()
        TweenService:Create(elem, TWEEN_INFO_SHORT, { BackgroundColor3 = state and COLORS.ACCENT_GREEN or COLORS.BG_ELEMENT_OFF + Color3.fromRGB(5, 5, 5) }):Play()
    end)
    elem.MouseLeave:Connect(function()
        TweenService:Create(elem, TWEEN_INFO_SHORT, { BackgroundColor3 = state and COLORS.ACCENT_GREEN or COLORS.BG_ELEMENT_OFF }):Play()
    end)

    elem.MouseButton1Click:Connect(function()
        state = not state
        update(state)
        if callback then
            callback(state)
        end
    end)
    
    -- Function to allow external state update (used by Main.lua to sync config)
    elem.UpdateState = function(newState)
        if state ~= newState then
            update(newState)
        end
    end

    return elem
end

-- Component.Slider
function Components.Slider(parent, name, min, max, default, step, callback)
    local value = default
    local range = max - min
    local isDragging = false
    local normalized = (default - min) / range
    local buttonCenterOffset = 9
    
    local container = create("Frame", {
        Name = "SliderContainer_" .. name:gsub("%s+", ""),
        BackgroundTransparency = 1,
        Size = UDim2.new(0, SIZES.ELEM_W, 0, SIZES.ELEM_H),
        Parent = parent,
    })

    local label = create("TextLabel", {
        Name = "Label",
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(0.5, 0, 1, 0),
        Font = Enum.Font.Gotham,
        Text = name .. ": " .. string.format(step == 1 and "%.0f" or "%.1f", default),
        TextColor3 = COLORS.TEXT,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = container,
    })

    local track = create("Frame", {
        Name = "Track",
        BackgroundColor3 = COLORS.BG_ELEMENT_OFF,
        Position = UDim2.new(0.5, 0, 0.5, -5),
        Size = UDim2.new(0.45, 0, 0, 10),
        Parent = container,
    })
    create("UICorner", { CornerRadius = UDim.new(0, 5) }, track)

    local fill = create("Frame", {
        Name = "Fill",
        BackgroundColor3 = COLORS.ACCENT_GREEN,
        Size = UDim2.new(normalized, 0, 1, 0),
        Parent = track,
    })
    create("UICorner", { CornerRadius = UDim.new(0, 5) }, fill)

    local button = create("Frame", {
        Name = "Button",
        BackgroundColor3 = COLORS.TEXT,
        BorderColor3 = COLORS.ACCENT_GREEN,
        BorderSizePixel = 1,
        Size = UDim2.new(0, 18, 0, 18),
        Position = UDim2.new(normalized, -buttonCenterOffset, 0.5, -buttonCenterOffset),
        ZIndex = 2,
        Parent = track,
    })
    create("UICorner", { CornerRadius = UDim.new(0.5, 0) }, button)
    create("UIAspectRatioConstraint", { AspectRatio = 1 }, button)

    local function updateValue(newValue)
        local steppedValue = math.floor(newValue / step + 0.5) * step -- Apply step rounding
        value = math.max(min, math.min(max, steppedValue))
        normalized = (value - min) / range

        label.Text = name .. ": " .. string.format(step == 1 and "%.0f" or "%.1f", value)
        
        -- Animation is fast or instant during drag, slightly smoother when setting externally
        local tweenInfo = isDragging and TWEEN_INFO_DRAG or TWEEN_INFO_SHORT
        
        TweenService:Create(fill, tweenInfo, { Size = UDim2.new(normalized, 0, 1, 0) }):Play()
        TweenService:Create(button, tweenInfo, { Position = UDim2.new(normalized, -buttonCenterOffset, 0.5, -buttonCenterOffset) }):Play()
    end
    updateValue(default) -- Initial set

    local function onDrag(input)
        if not isDragging then return end
        local pos = track.AbsolutePosition.X
        local width = track.AbsoluteSize.X
        local mouseX = input.Position.X
        local relativeX = math.max(0, math.min(width, mouseX - pos))
        local newNormalized = relativeX / width
        local newValue = min + (newNormalized * range)
        
        updateValue(newValue)
        if callback then
            callback(value)
        end
    end

    button.MouseButton1Down:Connect(function()
        isDragging = true
        button.BackgroundColor3 = COLORS.ACCENT_GREEN
        UserInputService.InputChanged:Connect(onDrag)
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 and isDragging then
            isDragging = false
            button.BackgroundColor3 = COLORS.TEXT
            -- Disconnect onDrag? No need, InputChanged will be disconnected by engine or reconnected on next MouseDown
        end
    end)
    
    -- Function to allow external state update (used by Main.lua to sync config)
    container.UpdateValue = function(newValue)
        updateValue(newValue)
    end

    return container
end

-- Component.Input
function Components.Input(parent, name, default, callback)
    local container = create("Frame", {
        Name = "InputContainer_" .. name:gsub("%s+", ""),
        BackgroundTransparency = 1,
        Size = UDim2.new(0, SIZES.ELEM_W, 0, SIZES.ELEM_H),
        Parent = parent,
    })
    
    local label = create("TextLabel", {
        Name = "Label",
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(0.5, 0, 1, 0),
        Font = Enum.Font.Gotham,
        Text = name .. ":",
        TextColor3 = COLORS.TEXT,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = container,
    })

    local input = create("TextBox", {
        Name = "TextBox",
        BackgroundColor3 = COLORS.BG_ELEMENT_OFF,
        Position = UDim2.new(0.5, 0, 0, 0),
        Size = UDim2.new(0.5, 0, 1, 0),
        Font = Enum.Font.Gotham,
        Text = default,
        TextColor3 = COLORS.TEXT,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        PlaceholderText = "",
        ClearTextOnFocus = false,
        Parent = container,
    })
    create("UICorner", { CornerRadius = SIZES.CORNER_RADIUS }, input)
    
    input.FocusLost:Connect(function(enterPressed, inputObject)
        if enterPressed or inputObject.UserInputType == Enum.UserInputType.Focus then
            if callback then
                callback(input.Text)
            end
        end
    end)
    
    -- Function to allow external text update (used by Main.lua to sync config)
    input.UpdateText = function(newText)
        input.Text = newText
    end

    return input
end

-- Component.Label
function Components.Label(parent, text, textSize, textXAlignment)
    local label = create("TextLabel", {
        Name = "Label",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 20),
        Font = Enum.Font.Gotham,
        Text = text,
        TextColor3 = COLORS.TEXT,
        TextSize = textSize or 14,
        TextXAlignment = textXAlignment or Enum.TextXAlignment.Left,
        Parent = parent,
    })
    return label
end

-- Component.Dropdown (Placeholder implementation for simplicity)
function Components.Dropdown(parent, name, options, default, callback)
    local state = default
    local container = create("Frame", {
        Name = "DropdownContainer_" .. name:gsub("%s+", ""),
        BackgroundTransparency = 1,
        Size = UDim2.new(0, SIZES.ELEM_W, 0, SIZES.ELEM_H),
        Parent = parent,
    })
    
    local button = create("TextButton", {
        Name = "DropdownButton",
        BackgroundColor3 = COLORS.BG_ELEMENT_OFF,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(1, 0, 1, 0),
        Font = Enum.Font.Gotham,
        Text = name .. ": " .. state,
        TextColor3 = COLORS.TEXT,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = container,
    })
    create("UICorner", { CornerRadius = SIZES.CORNER_RADIUS }, button)
    
    local function updateText(newText)
        state = newText
        button.Text = name .. ": " .. state
    end
    
    button.MouseButton1Click:Connect(function()
        -- In a real scenario, this would create a scrolling list (Config UI lists are complex).
        -- For simplicity, this implementation cycles through options.
        local currentIndex = table.find(options, state) or 1
        local nextIndex = (currentIndex % #options) + 1
        local nextOption = options[nextIndex]
        
        updateText(nextOption)
        if callback then
            callback(nextOption)
        end
    end)
    
    -- Function to allow external text update
    button.UpdateValue = updateText

    return button
end

-- COLUMN CLASS
local Column = {}
Column.new = function(parent, isRightColumn)
    local self = setmetatable({}, { __index = Column })
    
    self.parent = parent
    self.isRightColumn = isRightColumn
    self.yOffset = SIZES.COLUMN_SPACING_Y
    
    self.Frame = create("Frame", {
        Name = isRightColumn and "RightColumn" or "LeftColumn",
        BackgroundTransparency = 1,
        -- Full height, width is calculated by element width
        Size = UDim2.new(0, SIZES.ELEM_W, 1, 0),
        Position = UDim2.new(0, isRightColumn and SIZES.COLUMN_RIGHT_X or SIZES.COLUMN_LEFT_X, 0, 0),
        Parent = parent,
    })
    
    self.Frame.Archivable = false

    local function positionElement(elem)
        elem.Position = UDim2.new(0, 0, 0, self.yOffset)
        self.yOffset = self.yOffset + elem.Size.Y.Offset + SIZES.COLUMN_SPACING_Y
    end
    
    -- API for element creation in the column
    self.CreateToggle = function(options)
        local elem = Components.Toggle(self.Frame, options.Name, options.Default, options.Callback)
        positionElement(elem)
        return elem
    end
    
    self.CreateSlider = function(options)
        local elem = Components.Slider(self.Frame, options.Name, options.Min, options.Max, options.Default, options.Step or 1, options.Callback)
        positionElement(elem)
        return elem
    end
    
    self.CreateInput = function(options)
        local elem = Components.Input(self.Frame, options.Name, options.Default, options.Callback)
        positionElement(elem)
        return elem
    end
    
    self.CreateLabel = function(options)
        local elem = Components.Label(self.Frame, options.Text, options.TextSize, options.TextXAlignment)
        positionElement(elem)
        return elem
    end
    
    self.CreateDropdown = function(options)
        local elem = Components.Dropdown(self.Frame, options.Name, options.Options, options.Default, options.Callback)
        positionElement(elem)
        return elem
    end
    
    return self
end

-- TAB CLASS
local Tab = {}
Tab.new = function(window, tabName, icon, tabIndex)
    local self = setmetatable({}, { __index = Tab })
    
    self.Window = window
    self.Name = tabName
    self.Icon = icon
    self.Index = tabIndex
    self.Elements = {}
    self.TabElements = {} -- Stores created columns and elements

    -- Tab Content Container (for holding elements)
    self.ContentFrame = create("Frame", {
        Name = tabName .. "Content",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Visible = false,
        Parent = window.ContentFrame
    })

    -- Sidebar Tab Button
    self.TabButton = create("TextButton", {
        Name = "Tab_" .. tabIndex,
        BackgroundColor3 = COLORS.BG_MAIN,
        Size = UDim2.new(1, 0, 0, SIZES.SIDEBAR_W),
        Text = icon .. "\n" .. tabName,
        Font = Enum.Font.Gotham,
        TextSize = 10,
        TextColor3 = COLORS.TEXT,
        TextWrapped = true,
        Parent = window.Sidebar,
    })
    
    self.Indicator = create("Frame", {
        Name = "Indicator",
        BackgroundColor3 = COLORS.ACCENT_GREEN,
        Size = UDim2.new(0, 0, 1, 0),
        Parent = self.TabButton,
    })

    self.TabButton.MouseButton1Click:Connect(function()
        window:SwitchTab(self)
    end)
    
    -- Tab Content Layout Management
    local currentColumnY = SIZES.COLUMN_SPACING_Y -- Initial offset for autolayout

    self.CreateColumn = function(isRightColumn)
        local newColumn = Column.new(self.ContentFrame, isRightColumn)
        table.insert(self.TabElements, newColumn.Frame)
        return newColumn
    end
    
    -- Fallback/Default Column if no explicit column is created
    self.GetDefaultColumn = function()
        if not self._defaultColumn then
            self._defaultColumn = self:CreateColumn(false)
        end
        return self._defaultColumn
    end
    
    -- Direct Element Creation (Puts them in the default left column)
    self.CreateToggle = function(options) return self.GetDefaultColumn():CreateToggle(options) end
    self.CreateSlider = function(options) return self.GetDefaultColumn():CreateSlider(options) end
    self.CreateInput = function(options) return self.GetDefaultColumn():CreateInput(options) end
    self.CreateLabel = function(options) return self.GetDefaultColumn():CreateLabel(options) end
    self.CreateDropdown = function(options) return self.GetDefaultColumn():CreateDropdown(options) end

    return self
end

-- WINDOW CLASS (Main Control)
local Window = {}
Window.new = function(title, keybind)
    local self = setmetatable({}, { __index = Window })
    
    self.Title = title
    self.ToggleKey = keybind
    self.Tabs = {}
    self.CurrentTab = nil
    self.IsVisible = false
    self.GuiOpacity = 0 -- 0.0 is opaque in this context (1 - transparency)

    -- 1. ScreenGui
    self.ScreenGui = create("ScreenGui", {
        Name = "CrimScreenGui",
        Parent = CoreGui,
        DisplayOrder = 999,
        ResetOnSpawn = false,
    })
    
    -- 2. MainFrame (The whole UI container)
    self.MainFrame = create("Frame", {
        Name = "MainFrame",
        BackgroundColor3 = COLORS.BG_WINDOW_ACTIVE, -- The main body/container color
        BackgroundTransparency = 1, -- Start transparent, opacity slider will change this
        Position = UDim2.new(0.5, -285, 0.5, -200),
        Size = UDim2.new(0, 570, 0, 400),
        Visible = false, -- Hidden by default
        ZIndex = 10,
        Parent = self.ScreenGui,
    })
    create("UICorner", { CornerRadius = SIZES.CORNER_RADIUS }, self.MainFrame)

    -- 3. Header
    self.Header = create("Frame", {
        Name = "Header",
        BackgroundColor3 = COLORS.BG_MAIN,
        Size = UDim2.new(1, 0, 0, SIZES.HEADER_H),
        Parent = self.MainFrame,
    })
    create("TextLabel", {
        Name = "TitleLabel",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Font = Enum.Font.GothamSemibold,
        Text = title,
        TextColor3 = COLORS.TEXT,
        TextSize = 18,
        Parent = self.Header,
    })
    
    -- 4. Sidebar
    self.Sidebar = create("Frame", {
        Name = "Sidebar",
        BackgroundColor3 = COLORS.BG_MAIN,
        Position = UDim2.new(0, 0, 0, SIZES.HEADER_H),
        Size = UDim2.new(0, SIZES.SIDEBAR_W, 1, -SIZES.HEADER_H),
        Parent = self.MainFrame,
    })
    create("UIListLayout", {
        Padding = UDim.new(0, 0),
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        VerticalAlignment = Enum.VerticalAlignment.Top,
        SortOrder = Enum.SortOrder.LayoutOrder,
    }, self.Sidebar)

    -- 5. ContentFrame (Holds tab content containers)
    self.ContentFrame = create("Frame", {
        Name = "ContentFrame",
        BackgroundTransparency = 1,
        Position = UDim2.new(0, SIZES.SIDEBAR_W, 0, SIZES.HEADER_H),
        Size = UDim2.new(1, -SIZES.SIDEBAR_W, 1, -SIZES.HEADER_H),
        ClipsDescendants = true,
        Parent = self.MainFrame,
    })
    
    -- 6. TargetInfoWindow (Custom UI Component)
    self.TargetInfoWindow = Components.TargetInfoWindow(self.MainFrame)

    -- Opacity Control Setup (This element lives in the Header but controls MainFrame transparency)
    self.OpacitySlider = Components.Slider(self.Header, "Прозрачность", 0, 0.9, 0, 0.05, function(value)
        self:SetOpacity(value)
    end)
    self.OpacitySlider.Position = UDim2.new(1, -SIZES.ELEM_W - 10, 0.5, -SIZES.ELEM_H/2)
    self.OpacitySlider.Track.Fill.BackgroundColor3 = COLORS.ACCENT_BLUE -- Override to blue
    self.OpacitySlider.Button.BorderColor3 = COLORS.ACCENT_BLUE -- Override to blue
    self.OpacitySlider.Label.TextXAlignment = Enum.TextXAlignment.Right
    
    self.SetOpacity = function(value)
        -- Convert 0.0-0.9 (GUI Opacity) to 1.0-0.1 (Transparency)
        self.GuiOpacity = value
        local transparency = 1 - value
        self.MainFrame.BackgroundTransparency = transparency
        self.OpacitySlider.Label.Text = "Прозрачность: " .. string.format("%.0f%%", value * 100 / 0.9)
    end
    self:SetOpacity(0) -- Set initial to 0 (fully opaque)

    -- Show/Hide Logic
    self:ToggleGui(false)
    self:SetupInputToggle()

    return self
end

function Window:CreateTab(name, icon)
    local tabIndex = #self.Tabs + 1
    local newTab = Tab.new(self, name, icon, tabIndex)
    table.insert(self.Tabs, newTab)
    
    if not self.CurrentTab then
        self:SwitchTab(newTab)
    end
    
    return newTab
end

function Window:SwitchTab(newTab)
    if self.CurrentTab == newTab then return end
    
    -- Deactivate old tab
    if self.CurrentTab then
        self.CurrentTab.ContentFrame.Visible = false
        TweenService:Create(self.CurrentTab.Indicator, TWEEN_INFO_TAB, { Size = UDim2.new(0, 0, 1, 0) }):Play()
        TweenService:Create(self.CurrentTab.TabButton, TWEEN_INFO_TAB, { BackgroundColor3 = COLORS.BG_MAIN }):Play()
    end
    
    -- Activate new tab
    self.CurrentTab = newTab
    newTab.ContentFrame.Visible = true
    TweenService:Create(newTab.Indicator, TWEEN_INFO_TAB, { Size = UDim2.new(0, SIZES.TAB_INDICATOR_W, 1, 0) }):Play()
    TweenService:Create(newTab.TabButton, TWEEN_INFO_TAB, { BackgroundColor3 = COLORS.BG_WINDOW_ACTIVE }):Play()
end

function Window:ToggleGui(newState)
    self.IsVisible = newState
    self.MainFrame.Visible = newState
    
    if newState then
        UserInputService.MouseBehavior = Enum.UserInputType.Default
    else
        -- If game allows, return mouse to center/lock
        UserInputService.MouseBehavior = Enum.UserInputType.Default
    end
end

function Window:SetupInputToggle()
    local conn
    conn = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if input.KeyCode == self.ToggleKey then
            self:ToggleGui(not self.IsVisible)
        end
    end)
end

-- EXPORTED LIBRARY API

function Library:CreateWindow(options)
    local options = options or {}
    local window = Window.new(options.Title or "CrimUI", options.Keybind or Enum.KeyCode.Insert)
    return window
end

return Library
