--[[
    RageLib - GUI Library (1:1 ClickGui.lua Style)
    Полная реализация визуального стиля и функционала Ragebot UI.
]]

local Library = {}

-- Сервисы Roblox
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")

-- Настройки GUI
local GuiToggleKey = Enum.KeyCode.Insert -- Клавиша для открытия/закрытия
local IsGuiVisible = false

-- Тема и стили, извлеченные из ClickGui.lua (Ragebot UI)
local RageTheme = {
    -- Цвета
    BACKGROUND = Color3.fromRGB(20, 20, 20),      -- MainFrame
    HEADER_SIDEBAR = Color3.fromRGB(18, 18, 18),  -- Header, Sidebar
    SECTION_BG = Color3.fromRGB(25, 25, 25),      -- Section Background
    ELEMENT_BG = Color3.fromRGB(28, 28, 28),      -- Toggle/Slider/Button frame
    
    ACCENT_BLUE = Color3.fromRGB(60, 160, 255),   -- Active indicator, Slider progress, Toggle track/knob
    ACCENT_YELLOW = Color3.fromRGB(255, 200, 50), -- Active Toggle label text
    
    TEXT_MAIN = Color3.fromRGB(255, 255, 255),    -- Title text
    TEXT_INACTIVE = Color3.fromRGB(200, 200, 200),-- Label text (inactive)
    TEXT_SECTION = Color3.fromRGB(180, 180, 180), -- Section title text
    TEXT_SLIDER_VALUE = Color3.fromRGB(255, 255, 255), -- Slider value text (белый)
    
    -- Размеры/Шрифты
    FONT_NORMAL = Enum.Font.Gotham,
    FONT_BOLD = Enum.Font.GothamBold,
    TEXT_SIZE_TITLE = 20,
    TEXT_SIZE_SECTION = 12,
    TEXT_SIZE_ELEMENT = 13,
    TEXT_SIZE_VALUE = 10,

    WINDOW_SIZE = Vector2.new(843, 575),         -- MainFrame size
    HEADER_HEIGHT = 60,                          -- Header size
    SIDEBAR_WIDTH = 70,                          -- Sidebar size
    SECTION_WIDTH = 350,                         -- Section width
    SECTION_HEIGHT_CONTENT = 475,                -- Content section height
    SECTION_CORNER = 6,                          -- Section corner radius
    
    ELEMENT_HEIGHT = 30,                         -- Toggle/Slider/Button height
    ELEMENT_CORNER = 4,                          -- Element corner radius
    PADDING_ELEMENT = 18,                        -- Padding for elements inside section
    PADDING_SECTION = 18,                        -- Padding from main content to section
    SPACING_ELEMENT = 5,                         -- Small vertical spacing between elements
    
    TOGGLE_TRACK_SIZE = Vector2.new(32, 20),     -- Toggle background size
    TOGGLE_KNOB_SIZE = Vector2.new(12, 12),      -- Toggle knob size
}

-- Вспомогательная функция для создания объектов
local function create(className, properties)
    local obj = Instance.new(className)
    for k, v in pairs(properties) do
        obj[k] = v
    end
    return obj
end

-- Вспомогательная функция для обновления Toggle UI
local function updateToggleUI(frame, state)
    local Label = frame:FindFirstChild("Label")
    local ToggleBg = frame:FindFirstChild("ToggleBg")
    local ToggleButton = ToggleBg:FindFirstChild("ToggleButton")
    
    -- Обновление цвета текста
    Label.TextColor3 = state and RageTheme.ACCENT_YELLOW or RageTheme.TEXT_INACTIVE

    -- Анимация кнопки
    local targetX = state and 1 or 0
    TweenService:Create(ToggleButton, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
        BackgroundColor3 = Color3.fromRGB(255, 255, 255), -- Кнопка всегда белая
        Position = state and UDim2.new(1, -RageTheme.TOGGLE_KNOB_SIZE.X - 4, 0.5, -RageTheme.TOGGLE_KNOB_SIZE.Y / 2) or UDim2.new(0, 4, 0.5, -RageTheme.TOGGLE_KNOB_SIZE.Y / 2)
    }):Play()
    
    -- Анимация трека (фон)
    TweenService:Create(ToggleBg, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
        BackgroundColor3 = state and RageTheme.ACCENT_BLUE or Color3.fromRGB(20, 20, 20)
    }):Play()
end

--================================================================================================================
-- БИБЛИОТЕКА / ОКНО (Window)
--================================================================================================================

local WindowValue = { Tabs = {}, CurrentTab = nil }

function Library:CreateWindow(settings)
    settings = settings or {}

    if CoreGui:FindFirstChild("RagebotUI") then
        warn("RageLib: GUI already exists.")
        return CoreGui.RagebotUI.MainFrame.Object
    end

    local ScreenGui = create("ScreenGui", {
        Name = "RagebotUI",
        Parent = CoreGui,
        DisplayOrder = 999,
        IgnoreGuiInset = true,
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })

    local MainFrame = create("Frame", {
        Name = "MainFrame",
        Parent = ScreenGui,
        Size = UDim2.fromOffset(RageTheme.WINDOW_SIZE.X, RageTheme.WINDOW_SIZE.Y),
        Position = UDim2.new(0.5, -RageTheme.WINDOW_SIZE.X / 2, 0.5, -RageTheme.WINDOW_SIZE.Y / 2),
        BackgroundColor3 = RageTheme.BACKGROUND,
        BorderSizePixel = 0,
        Visible = IsGuiVisible,
        Active = true,
    })

    create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = MainFrame,
    })

    -- Хедер (для перетаскивания и заголовка)
    local Header = create("Frame", {
        Name = "Header",
        Parent = MainFrame,
        BackgroundColor3 = RageTheme.HEADER_SIDEBAR,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, RageTheme.HEADER_HEIGHT),
        Active = true, -- Сделать активным для перетаскивания
        ZIndex = 2
    })

    create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = Header,
    })

    -- Заголовок
    create("TextLabel", {
        Name = "Title",
        Parent = Header,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, RageTheme.SIDEBAR_WIDTH, 0, 18),
        Size = UDim2.new(0, 200, 0, 24),
        Font = RageTheme.FONT_BOLD,
        Text = settings.Name or "Ragebot",
        TextColor3 = RageTheme.TEXT_MAIN,
        TextSize = RageTheme.TEXT_SIZE_TITLE,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 3
    })

    -- Боковая панель для вкладок
    local Sidebar = create("Frame", {
        Name = "Sidebar",
        Parent = MainFrame,
        BackgroundColor3 = RageTheme.HEADER_SIDEBAR,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, RageTheme.HEADER_HEIGHT),
        Size = UDim2.new(0, RageTheme.SIDEBAR_WIDTH, 1, -RageTheme.HEADER_HEIGHT),
        ZIndex = 2
    })
    
    create("UIListLayout", {
        Name = "TabListLayout",
        Parent = Sidebar,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 10), -- Небольшой отступ между вкладками
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        VerticalAlignment = Enum.VerticalAlignment.Top,
    })

    -- Контейнер для содержимого вкладок
    local ContentFrame = create("Frame", {
        Name = "ContentFrame",
        Parent = MainFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, RageTheme.SIDEBAR_WIDTH, 0, RageTheme.HEADER_HEIGHT),
        Size = UDim2.new(1, -RageTheme.SIDEBAR_WIDTH, 1, -RageTheme.HEADER_HEIGHT),
        ClipsDescendants = true,
    })
    
    local TabContainer = create("Frame", {
        Name = "TabContainer",
        Parent = ContentFrame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Visible = true,
    })

    -- Логика перетаскивания (только за хедер)
    local isDragging = false
    local dragStart = Vector2.new()
    local startPos = UDim2.new()
    
    local function update(input)
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    
    Header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            update(input)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = false
        end
    end)
    
    -- Видимость (Insert Key)
    UserInputService.InputBegan:Connect(function(input, gameProcessedEvent)
        if gameProcessedEvent then return end
        if input.KeyCode == GuiToggleKey then
            IsGuiVisible = not IsGuiVisible
            MainFrame.Visible = IsGuiVisible
        end
    end)

    --================================================================================================================
    -- ВКЛАДКА (Tab)
    --================================================================================================================

    local tabIndexCounter = 0
    local function switchTab(tabIndex, tabButtonFrame, tabContentPage)
        -- Деактивация всех
        for _, tab in pairs(WindowValue.Tabs) do
            tab.Frame.BackgroundColor3 = RageTheme.HEADER_SIDEBAR
            TweenService:Create(tab.Indicator, TweenInfo.new(0.2), {Size = UDim2.new(0, 0, 1, 0)}):Play()
            tab.Page.Visible = false
        end
        
        -- Активация текущей
        TweenService:Create(tabButtonFrame, TweenInfo.new(0.2), {BackgroundColor3 = RageTheme.SECTION_BG}):Play()
        TweenService:Create(tabButtonFrame:FindFirstChild("Indicator"), TweenInfo.new(0.2), {Size = UDim2.new(0, 4, 1, 0)}):Play()
        
        tabContentPage.Visible = true
        
        WindowValue.CurrentTab = tabIndex
        -- Не меняем Title.Text, т.к. в ClickGui.lua он остается Ragebot
    end
    
    function WindowValue:CreateTab(tabSettings)
        tabIndexCounter = tabIndexCounter + 1
        local TabValue = { Elements = {}, Columns = {} }
        
        -- Контейнер страницы вкладки (TabContentPage)
        local TabContentPage = create("Frame", {
            Name = tabSettings.Name,
            Parent = TabContainer,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            Visible = false,
        })
        
        -- Кнопка вкладки в Sidebar
        local TabButtonFrame = create("Frame", {
            Name = "Tab_" .. tabIndexCounter,
            Parent = Sidebar,
            BackgroundColor3 = RageTheme.HEADER_SIDEBAR,
            BorderSizePixel = 0,
            Size = UDim2.new(1, 0, 0, 60), -- Tab size 60
        })
        
        local ActiveIndicator = create("Frame", {
            Name = "Indicator",
            Parent = TabButtonFrame,
            BackgroundColor3 = RageTheme.ACCENT_BLUE,
            BorderSizePixel = 0,
            Position = UDim2.new(0, 0, 0, 0),
            Size = UDim2.new(0, 0, 1, 0), -- Изначально 0 ширина
        })
        
        -- Текст/Иконка вкладки
        create("TextLabel", {
            Name = "Icon",
            Parent = TabButtonFrame,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            Font = RageTheme.FONT_BOLD,
            Text = tabSettings.Name, 
            TextColor3 = RageTheme.TEXT_MAIN,
            TextSize = RageTheme.TEXT_SIZE_TITLE,
            ZIndex = 3
        })
        
        local TabButton = create("TextButton", {
            Name = "TabButton",
            Parent = TabButtonFrame,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            Text = "",
            ZIndex = 4
        })

        TabButton.MouseButton1Click:Connect(function()
            switchTab(tabIndexCounter, TabButtonFrame, TabContentPage)
        end)
        
        -- Hover эффект
        TabButton.MouseEnter:Connect(function()
            if WindowValue.CurrentTab ~= tabIndexCounter then
                TweenService:Create(TabButtonFrame, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(22, 22, 22)}):Play()
            end
        end)
        
        TabButton.MouseLeave:Connect(function()
            if WindowValue.CurrentTab ~= tabIndexCounter then
                TweenService:Create(TabButtonFrame, TweenInfo.new(0.15), {BackgroundColor3 = RageTheme.HEADER_SIDEBAR}):Play()
            end
        end)
        
        -- Добавляем колонки/секции
        local SectionNames = {"GLOBALS", "AIMBOT"} -- Как в ClickGui.lua
        for i = 1, 2 do 
            local SectionFrame = create("Frame", {
                Name = "Section" .. i,
                Parent = TabContentPage,
                BackgroundColor3 = RageTheme.SECTION_BG,
                BorderSizePixel = 0,
                Position = UDim2.new(0, RageTheme.PADDING_SECTION + (i - 1) * (RageTheme.SECTION_WIDTH + RageTheme.PADDING_SECTION), RageTheme.PADDING_SECTION, 0),
                Size = UDim2.new(0, RageTheme.SECTION_WIDTH, 0, RageTheme.SECTION_HEIGHT_CONTENT),
                ClipsDescendants = false,
                ZIndex = 2
            })

            create("UICorner", {
                CornerRadius = UDim.new(0, RageTheme.SECTION_CORNER),
                Parent = SectionFrame,
            })
            
            -- Заголовок секции
            create("TextLabel", {
                Name = "Title",
                Parent = SectionFrame,
                BackgroundTransparency = 1,
                Position = UDim2.new(0, RageTheme.PADDING_ELEMENT, 0, 10),
                Size = UDim2.new(1, -RageTheme.PADDING_ELEMENT * 2, 0, 25),
                Font = RageTheme.FONT_BOLD,
                Text = SectionNames[i],
                TextColor3 = RageTheme.TEXT_SECTION,
                TextSize = RageTheme.TEXT_SIZE_SECTION,
                TextXAlignment = Enum.TextXAlignment.Left,
            })
            
            -- Контейнер для элементов с авторазметкой
            local List = create("Frame", {
                Name = "List",
                Parent = SectionFrame,
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 0, 0, 45), -- Начало после заголовка
                Size = UDim2.new(1, 0, 1, -45),
            })
            
            create("UIListLayout", {
                Parent = List,
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, RageTheme.SPACING_ELEMENT),
                HorizontalAlignment = Enum.HorizontalAlignment.Center,
                VerticalAlignment = Enum.VerticalAlignment.Top,
                FillDirection = Enum.FillDirection.Vertical,
            })
            
            TabValue.Columns[i] = { Frame = List, ComponentCount = 0 }
        end
        
        WindowValue.Tabs[tabIndexCounter] = { 
            Name = tabSettings.Name, 
            Frame = TabButtonFrame, 
            Indicator = ActiveIndicator, 
            Page = TabContentPage 
        }

        -- Автоматический выбор первой созданной вкладки
        if tabIndexCounter == 1 then
            switchTab(1, TabButtonFrame, TabContentPage)
        end

        -- Вспомогательная функция для добавления элемента в колонку с наименьшим количеством элементов
        local function getNextColumn()
            if TabValue.Columns[1].ComponentCount <= TabValue.Columns[2].ComponentCount then
                TabValue.Columns[1].ComponentCount = TabValue.Columns[1].ComponentCount + 1
                return TabValue.Columns[1].Frame
            else
                TabValue.Columns[2].ComponentCount = TabValue.Columns[2].ComponentCount + 1
                return TabValue.Columns[2].Frame
            end
        end

        --================================================================================================================
        -- ЭЛЕМЕНТЫ УПРАВЛЕНИЯ
        --================================================================================================================

        -- Переключатель (Toggle)
        function TabValue:CreateToggle(elementSettings)
            local Parent = getNextColumn()
            local ToggleValue = elementSettings.Default or false
            
            local ToggleFrame = create("Frame", {
                Name = elementSettings.Name .. "Toggle",
                Parent = Parent,
                Size = UDim2.new(1, -RageTheme.PADDING_ELEMENT * 2, 0, RageTheme.ELEMENT_HEIGHT),
                BackgroundColor3 = RageTheme.ELEMENT_BG,
                BorderSizePixel = 0,
                ZIndex = 5
            })
            create("UICorner", { CornerRadius = UDim.new(0, RageTheme.ELEMENT_CORNER), Parent = ToggleFrame })
            
            local Label = create("TextLabel", {
                Name = "Label",
                Parent = ToggleFrame,
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 12, 0, 0),
                Size = UDim2.new(0, 250, 1, 0),
                Font = RageTheme.FONT_NORMAL,
                Text = elementSettings.Name,
                TextColor3 = ToggleValue and RageTheme.ACCENT_YELLOW or RageTheme.TEXT_INACTIVE,
                TextSize = RageTheme.TEXT_SIZE_ELEMENT,
                TextXAlignment = Enum.TextXAlignment.Left,
            })
            
            -- Трек переключателя (фон)
            local ToggleBg = create("Frame", {
                Name = "ToggleBg",
                Parent = ToggleFrame,
                BackgroundColor3 = ToggleValue and RageTheme.ACCENT_BLUE or Color3.fromRGB(20, 20, 20),
                BorderSizePixel = 0,
                Position = UDim2.new(1, -45, 0.5, -RageTheme.TOGGLE_TRACK_SIZE.Y / 2),
                Size = UDim2.new(0, RageTheme.TOGGLE_TRACK_SIZE.X, 0, RageTheme.TOGGLE_TRACK_SIZE.Y),
                ZIndex = 6
            })
            create("UICorner", { CornerRadius = UDim.new(1, 0), Parent = ToggleBg })
            
            -- Кнопка (Knob)
            local KnobSize = RageTheme.TOGGLE_KNOB_SIZE
            local ToggleButton = create("Frame", {
                Name = "ToggleButton",
                Parent = ToggleBg,
                BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                BorderSizePixel = 0,
                Position = ToggleValue and UDim2.new(1, -KnobSize.X - 4, 0.5, -KnobSize.Y / 2) or UDim2.new(0, 4, 0.5, -KnobSize.Y / 2),
                Size = UDim2.new(0, KnobSize.X, 0, KnobSize.Y),
                ZIndex = 7
            })
            create("UICorner", { CornerRadius = UDim.new(1, 0), Parent = ToggleButton })
            
            local Hitbox = create("TextButton", {
                Name = "Hitbox",
                Parent = ToggleFrame,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 1, 0),
                Text = "",
                ZIndex = 8
            })

            local function updateToggle(newValue)
                ToggleValue = newValue
                updateToggleUI(ToggleFrame, ToggleValue)
                
                if elementSettings.Callback then
                    pcall(elementSettings.Callback, ToggleValue)
                end
            end
            
            Hitbox.MouseButton1Click:Connect(function()
                updateToggle(not ToggleValue)
            end)
            
            -- Hover эффект
            ToggleFrame.MouseEnter:Connect(function()
                TweenService:Create(ToggleFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {
                    BackgroundColor3 = Color3.fromRGB(32, 32, 32)
                }):Play()
            end)
            
            ToggleFrame.MouseLeave:Connect(function()
                TweenService:Create(ToggleFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {
                    BackgroundColor3 = RageTheme.ELEMENT_BG
                }):Play()
            end)

            updateToggleUI(ToggleFrame, ToggleValue) -- Инициализация

            return { Name = elementSettings.Name, Value = ToggleValue, Set = updateToggle }
        end
        
        -- Слайдер (Slider)
        function TabValue:CreateSlider(elementSettings)
            local Parent = getNextColumn()
            local MIN = elementSettings.Min or 0
            local MAX = elementSettings.Max or 100
            local STEP = elementSettings.Step or 1
            local CurrentValue = elementSettings.Default or MIN
            
            local SliderFrame = create("Frame", {
                Name = elementSettings.Name .. "Slider",
                Parent = Parent,
                Size = UDim2.new(1, -RageTheme.PADDING_ELEMENT * 2, 0, RageTheme.ELEMENT_HEIGHT),
                BackgroundColor3 = RageTheme.ELEMENT_BG,
                BorderSizePixel = 0,
                ZIndex = 5
            })
            create("UICorner", { CornerRadius = UDim.new(0, RageTheme.ELEMENT_CORNER), Parent = SliderFrame })
            
            local Label = create("TextLabel", {
                Name = "Label",
                Parent = SliderFrame,
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 12, 0, 0),
                Size = UDim2.new(0, 200, 1, 0),
                Font = RageTheme.FONT_NORMAL,
                Text = elementSettings.Name,
                TextColor3 = RageTheme.TEXT_INACTIVE,
                TextSize = RageTheme.TEXT_SIZE_ELEMENT,
                TextXAlignment = Enum.TextXAlignment.Left,
            })
            
            local ValueLabel = create("TextLabel", {
                Name = "ValueLabel",
                Parent = SliderFrame,
                BackgroundTransparency = 1,
                Position = UDim2.new(1, -45, 0, 0),
                Size = UDim2.new(0, 38, 1, 0),
                Font = RageTheme.FONT_BOLD,
                Text = tostring(CurrentValue),
                TextColor3 = RageTheme.TEXT_SLIDER_VALUE,
                TextSize = RageTheme.TEXT_SIZE_VALUE,
                TextXAlignment = Enum.TextXAlignment.Right,
                ZIndex = 6
            })

            -- Трек ползунка
            local SliderTrack = create("Frame", {
                Name = "SliderTrack",
                Parent = SliderFrame,
                BackgroundColor3 = Color3.fromRGB(25, 25, 25),
                BorderSizePixel = 0,
                Position = UDim2.new(0, 12, 1, -12),
                Size = UDim2.new(1, -55, 0, 4),
                ZIndex = 6
            })
            create("UICorner", { CornerRadius = UDim.new(1, 0), Parent = SliderTrack })
            
            local SliderFill = create("Frame", {
                Name = "SliderFill",
                Parent = SliderTrack,
                BackgroundColor3 = RageTheme.ACCENT_BLUE,
                BorderSizePixel = 0,
                Size = UDim2.new(0, 0, 1, 0),
                ZIndex = 7
            })
            create("UICorner", { CornerRadius = UDim.new(1, 0), Parent = SliderFill })

            local SliderThumb = create("Frame", {
                Name = "SliderThumb",
                Parent = SliderTrack,
                BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                BorderColor3 = RageTheme.ACCENT_BLUE,
                BorderSizePixel = 2,
                Position = UDim2.new(0, -8, 0.5, -8),
                Size = UDim2.new(0, 16, 0, 16),
                ZIndex = 8
            })
            create("UICorner", { CornerRadius = UDim.new(1, 0), Parent = SliderThumb })

            local isDragging = false
            local function updateSlider(input)
                local barPos = SliderTrack.AbsolutePosition
                local barWidth = SliderTrack.AbsoluteSize.X
                local mousePos = input.UserInputType == Enum.UserInputType.MouseMovement and UserInputService:GetMouseLocation() or input.Position
                
                local relativeX = math.clamp(mousePos.X - barPos.X, 0, barWidth)
                local normalized = relativeX / barWidth
                local newValue = MIN + (normalized * (MAX - MIN))
                
                -- Применение шага и ограничение
                local value = math.floor(newValue / STEP + 0.5) * STEP
                value = math.max(MIN, math.min(MAX, value))
                
                CurrentValue = value
                
                local normalizedValue = (value - MIN) / (MAX - MIN)
                local delta = math.clamp(normalizedValue, 0, 1)

                -- Обновление текста
                ValueLabel.Text = string.format("%.f", value) 
                
                -- Обновление UI
                TweenService:Create(SliderFill, TweenInfo.new(0.1), { Size = UDim2.new(delta, 0, 1, 0) }):Play()
                TweenService:Create(SliderThumb, TweenInfo.new(0.1), { Position = UDim2.new(delta, -8, 0.5, -8) }):Play()

                if elementSettings.Callback then
                    pcall(elementSettings.Callback, CurrentValue)
                end
            end
            
            -- Логика перетаскивания (события)
            local function handleInput(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    isDragging = true
                    updateSlider(input)
                end
            end
            
            SliderTrack.InputBegan:Connect(handleInput)
            SliderThumb.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then isDragging = true end end)
            
            UserInputService.InputChanged:Connect(function(input)
                if isDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                    updateSlider(input)
                end
            end)
            
            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    isDragging = false
                end
            end)
            
            -- Hover эффект
            SliderFrame.MouseEnter:Connect(function()
                TweenService:Create(SliderFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {
                    BackgroundColor3 = Color3.fromRGB(32, 32, 32)
                }):Play()
            end)
            
            SliderFrame.MouseLeave:Connect(function()
                TweenService:Create(SliderFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {
                    BackgroundColor3 = RageTheme.ELEMENT_BG
                }):Play()
            end)

            updateSlider({Position = Vector2.new()}) -- Инициализация

            return { Name = elementSettings.Name, Value = CurrentValue, Set = function(v) CurrentValue = v; updateSlider({Position = Vector2.new()}) end }
        end

        -- Кнопка (Button)
        function TabValue:CreateButton(elementSettings)
            local Parent = getNextColumn()
            
            local ButtonFrame = create("TextButton", {
                Name = elementSettings.Name .. "Button",
                Parent = Parent,
                Size = UDim2.new(1, -RageTheme.PADDING_ELEMENT * 2, 0, RageTheme.ELEMENT_HEIGHT),
                BackgroundColor3 = RageTheme.ELEMENT_BG,
                BorderSizePixel = 0,
                Font = RageTheme.FONT_NORMAL,
                Text = elementSettings.Name,
                TextColor3 = RageTheme.TEXT_INACTIVE,
                TextSize = RageTheme.TEXT_SIZE_ELEMENT,
            })
            create("UICorner", { CornerRadius = UDim.new(0, RageTheme.ELEMENT_CORNER), Parent = ButtonFrame })

            ButtonFrame.MouseButton1Click:Connect(function()
                if elementSettings.Callback then
                    pcall(elementSettings.Callback)
                end
            end)
            
            -- Hover эффект
            ButtonFrame.MouseEnter:Connect(function()
                TweenService:Create(ButtonFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {
                    BackgroundColor3 = Color3.fromRGB(32, 32, 32)
                }):Play()
            end)
            
            ButtonFrame.MouseLeave:Connect(function()
                TweenService:Create(ButtonFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {
                    BackgroundColor3 = RageTheme.ELEMENT_BG
                }):Play()
            end)

            return { Name = elementSettings.Name }
        end
        
        -- Бинды клавиш (Keybind)
        function TabValue:CreateKeybind(elementSettings)
            local Parent = getNextColumn()
            local CurrentKey = elementSettings.Default or "NONE"
            local isCapturing = false

            local KeybindFrame = create("TextButton", {
                Name = elementSettings.Name .. "Keybind",
                Parent = Parent,
                Size = UDim2.new(1, -RageTheme.PADDING_ELEMENT * 2, 0, RageTheme.ELEMENT_HEIGHT),
                BackgroundColor3 = RageTheme.ELEMENT_BG,
                BorderSizePixel = 0,
                Font = RageTheme.FONT_NORMAL,
                TextColor3 = RageTheme.TEXT_INACTIVE,
                TextSize = RageTheme.TEXT_SIZE_ELEMENT,
            })
            create("UICorner", { CornerRadius = UDim.new(0, RageTheme.ELEMENT_CORNER), Parent = KeybindFrame })

            local function updateText()
                KeybindFrame.Text = elementSettings.Name .. ": [" .. CurrentKey .. "]"
            end

            local connection
            KeybindFrame.MouseButton1Click:Connect(function()
                if isCapturing then return end
                isCapturing = true
                KeybindFrame.Text = elementSettings.Name .. ": [PRESS A KEY...]"
                
                if connection then connection:Disconnect() end

                connection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
                    if gameProcessed then return end
                    
                    if input.UserInputType == Enum.UserInputType.Keyboard or input.UserInputType == Enum.UserInputType.MouseButton1 then
                        connection:Disconnect()
                        isCapturing = false
                        
                        if input.KeyCode == Enum.KeyCode.Backspace or input.KeyCode == Enum.KeyCode.Delete then
                            CurrentKey = "NONE"
                        else
                            CurrentKey = input.KeyCode.Name
                        end
                        
                        updateText()
                        if elementSettings.Callback then
                            pcall(elementSettings.Callback, CurrentKey)
                        end
                    end
                end)
            end)
            
            updateText()
            
            -- Hover эффект
            KeybindFrame.MouseEnter:Connect(function()
                TweenService:Create(KeybindFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {
                    BackgroundColor3 = Color3.fromRGB(32, 32, 32)
                }):Play()
            end)
            
            KeybindFrame.MouseLeave:Connect(function()
                TweenService:Create(KeybindFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {
                    BackgroundColor3 = RageTheme.ELEMENT_BG
                }):Play()
            end)

            return { Name = elementSettings.Name, Value = CurrentKey, Set = function(newKey) CurrentKey = newKey; updateText() end }
        end


        return TabValue
    end

    WindowValue.Object = MainFrame 

    return WindowValue
end

if getgenv then
    getgenv().RageLib = Library
end

return Library
